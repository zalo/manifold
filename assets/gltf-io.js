class mt{constructor(){this._listeners={}}addEventListener(e,t){const r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t),this}removeEventListener(e,t){if(this._listeners===void 0)return this;const i=this._listeners[e];if(i!==void 0){const n=i.indexOf(t);n!==-1&&i.splice(n,1)}return this}dispatchEvent(e){if(this._listeners===void 0)return this;const r=this._listeners[e.type];if(r!==void 0){const i=r.slice(0);for(let n=0,a=i.length;n<a;n++)i[n].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class fe extends mt{constructor(e,t,r,i={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=r,this._attributes=i,!t.isOnGraph(r))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}}class bs extends mt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){return this.listParentEdges(e).map(t=>t.getParent())}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){return this.listChildEdges(e).map(t=>t.getChild())}disconnectParents(e,t){let r=this.listParentEdges(e);return t&&(r=r.filter(i=>t(i.getParent()))),r.forEach(i=>i.dispose()),this}createEdge(e,t,r,i){return this._registerEdge(new fe(e,t,r,i))}_registerEdge(e){this._edges.add(e);const t=e.getParent();this._parentEdges.has(t)||this._parentEdges.set(t,new Set),this._parentEdges.get(t).add(e);const r=e.getChild();return this._childEdges.has(r)||this._childEdges.set(r,new Set),this._childEdges.get(r).add(e),e.addEventListener("dispose",()=>this._removeEdge(e)),e}_removeEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function we(){return we=Object.assign||function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},we.apply(this,arguments)}function ot(s){return s instanceof fe}function Te(s){return Array.isArray(s)&&s[0]instanceof fe}function be(s){return!!(As(s)&&vs(s)instanceof fe)}function vs(s){for(const e in s)return s[e]}function As(s){return!!s&&Object.getPrototypeOf(s)===Object.prototype}const L=Symbol("attributes"),le=Symbol("immutableKeys");class yt extends mt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[L]=void 0,this[le]=void 0,this.graph=e,this[le]=new Set,this[L]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const r in e){const i=e[r];if(i instanceof yt){const n=this.graph.createEdge(r,this,i);n.addEventListener("dispose",()=>i.dispose()),this[le].add(r),t[r]=n}else t[r]=i}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const r in this[L]){const i=this[L][r];if(ot(i)){const n=i;n.getChild()===e&&this.setRef(r,t,n.getAttributes())}else if(Te(i)){const a=i.find(c=>c.getChild()===e);if(a){const c=a.getAttributes();this.removeRef(r,e).addRef(r,t,c)}}else if(be(i)){const n=i;for(const a in n){const c=n[a];c.getChild()===e&&this.setRefMap(r,a,t,c.getAttributes())}}}return this}get(e){return this[L][e]}set(e,t){return this[L][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[L][e];return t?t.getChild():null}setRef(e,t,r){if(this[le].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const i=this[L][e];if(i&&i.dispose(),!t)return this;const n=this.graph.createEdge(e,this,t,r);return n.addEventListener("dispose",()=>{delete this[L][e],this.dispatchEvent({type:"change",attribute:e})}),this[L][e]=n,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this[L][e].map(r=>r.getChild())}addRef(e,t,r){const i=this.graph.createEdge(e,this,t,r),n=this[L][e];return n.push(i),i.addEventListener("dispose",()=>{let a;for(;(a=n.indexOf(i))!==-1;)n.splice(a,1);this.dispatchEvent({type:"change",attribute:e})}),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){return this[L][e].filter(n=>n.getChild()===t).forEach(n=>n.dispose()),this}listRefMapKeys(e){return Object.keys(this[L][e])}listRefMapValues(e){return Object.values(this[L][e]).map(t=>t.getChild())}getRefMap(e,t){const r=this[L][e];return r[t]?r[t].getChild():null}setRefMap(e,t,r,i){const n=this[L][e],a=n[t];if(a&&a.dispose(),!r)return this;i=Object.assign(i||{},{key:t});const c=this.graph.createEdge(e,this,r,we({},i,{key:t}));return c.addEventListener("dispose",()=>{delete n[t],this.dispatchEvent({type:"change",attribute:e,key:t})}),n[t]=c,this.dispatchEvent({type:"change",attribute:e,key:t})}dispatchEvent(e){return super.dispatchEvent(we({},e,{target:this})),this.graph.dispatchEvent(we({},e,{target:this,type:`node:${e.type}`})),this}}const $t="v3.8.0",Ge="@glb.bin";var M,ze,$,ct,re;(function(s){s.ACCESSOR="Accessor",s.ANIMATION="Animation",s.ANIMATION_CHANNEL="AnimationChannel",s.ANIMATION_SAMPLER="AnimationSampler",s.BUFFER="Buffer",s.CAMERA="Camera",s.MATERIAL="Material",s.MESH="Mesh",s.PRIMITIVE="Primitive",s.PRIMITIVE_TARGET="PrimitiveTarget",s.NODE="Node",s.ROOT="Root",s.SCENE="Scene",s.SKIN="Skin",s.TEXTURE="Texture",s.TEXTURE_INFO="TextureInfo"})(M||(M={})),function(s){s.INTERLEAVED="interleaved",s.SEPARATE="separate"}(ze||(ze={})),function(s){s.ARRAY_BUFFER="ARRAY_BUFFER",s.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",s.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",s.OTHER="OTHER",s.SPARSE="SPARSE"}($||($={})),function(s){s[s.R=4096]="R",s[s.G=256]="G",s[s.B=16]="B",s[s.A=1]="A"}(ct||(ct={})),function(s){s.GLTF="GLTF",s.GLB="GLB"}(re||(re={}));const $e={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var Pe,ut=typeof Float32Array<"u"?Float32Array:Array;function st(s){return Math.hypot(s[0],s[1],s[2])}function ws(s,e,t){var r=e[0],i=e[1],n=e[2],a=t[3]*r+t[7]*i+t[11]*n+t[15];return s[0]=(t[0]*r+t[4]*i+t[8]*n+t[12])/(a=a||1),s[1]=(t[1]*r+t[5]*i+t[9]*n+t[13])/a,s[2]=(t[2]*r+t[6]*i+t[10]*n+t[14])/a,s}function Jr(s){const e={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},t=s.propertyType===M.NODE?[s]:s.listChildren();for(const r of t)r.traverse(i=>{const n=i.getMesh();if(!n)return;const a=Rs(n,i.getWorldMatrix());lt(a.min,e),lt(a.max,e)});return e}Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)}),Pe=new ut(3),ut!=Float32Array&&(Pe[0]=0,Pe[1]=0,Pe[2]=0);function Rs(s,e){const t={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const r of s.listPrimitives()){const i=r.getAttribute("POSITION");if(!i)continue;let n=[0,0,0],a=[0,0,0];for(let c=0;c<i.getCount();c++)n=i.getElement(c,n),a=ws(a,n,e),lt(a,t)}return t}function lt(s,e){for(let t=0;t<3;t++)e.min[t]=Math.min(s[t],e.min[t]),e.max[t]=Math.max(s[t],e.max[t])}class F{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}{const t=e.split(",")[1],r=e.indexOf("base64")>=0;return Buffer.from(t,r?"base64":"utf8")}}static encodeText(e){return typeof TextEncoder<"u"?new TextEncoder().encode(e):Buffer.from(e)}static decodeText(e){return typeof TextDecoder<"u"?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}static concat(e){let t=0;for(const n of e)t+=n.byteLength;const r=new Uint8Array(t);let i=0;for(const n of e)r.set(n,i),i+=n.byteLength;return r}static pad(e,t=0){const r=this.padNumber(e.byteLength);if(r===e.byteLength)return e;const i=new Uint8Array(r);if(i.set(e),t!==0)for(let n=e.byteLength;n<r;n++)i[n]=t;return i}static padNumber(e){return 4*Math.ceil(e/4)}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let r=e.byteLength;for(;r--;)if(e[r]!==t[r])return!1;return!0}static toView(e,t=0,r=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,r))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class ve{static hexToFactor(e,t){e=Math.floor(e);const r=t;return r[0]=(e>>16&255)/255,r[1]=(e>>8&255)/255,r[2]=(255&e)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[r,i,n]=this.convertLinearToSRGB(e,t);return 255*r<<16^255*i<<8^255*n<<0}static convertSRGBToLinear(e,t){const r=e,i=t;for(let n=0;n<3;n++)i[n]=r[n]<.04045?.0773993808*r[n]:Math.pow(.9478672986*r[n]+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const r=e,i=t;for(let n=0;n<3;n++)i[n]=r[n]<.0031308?12.92*r[n]:1.055*Math.pow(r[n],.41666)-.055;return t}}class Je{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return F.decodeText(e.slice(12,16))===Je.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}Je.PNG_FRIED_CHUNK_NAME="CgBI";class ne{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let r=0;const i=this.getSize(e,t);if(!i)return null;for(;i[0]>1||i[1]>1;)r+=i[0]*i[1]*4,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return r+=4,r}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}function Is(s,e){if(e>s.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(s.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return s}ne.impls={"image/jpeg":new class{match(s){return s.length>=3&&s[0]===255&&s[1]===216&&s[2]===255}getSize(s){let e,t,r=new DataView(s.buffer,s.byteOffset+4);for(;r.byteLength;){if(e=r.getUint16(0,!1),Is(r,e),t=r.getUint8(e+1),t===192||t===193||t===194)return[r.getUint16(e+7,!1),r.getUint16(e+5,!1)];r=new DataView(s.buffer,r.byteOffset+e+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(s){return 3}},"image/png":new Je};class ge{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return ne.mimeTypeToExtension(t)}return e.startsWith("data:model/gltf+json")?"gltf":e.startsWith("data:model/gltf-binary")?"glb":e.startsWith("data:application/")?"bin":e.split(/[\\/]/).pop().split(/[.]/).pop()}}function At(s){return Object.prototype.toString.call(s)==="[object Object]"}function se(s){if(At(s)===!1)return!1;const e=s.constructor;if(e===void 0)return!0;const t=e.prototype;return At(t)!==!1&&Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")!==!1}var rt,ht;(function(s){s[s.SILENT=4]="SILENT",s[s.ERROR=3]="ERROR",s[s.WARN=2]="WARN",s[s.INFO=1]="INFO",s[s.DEBUG=0]="DEBUG"})(ht||(ht={}));let ie=class Ae{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=Ae.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=Ae.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=Ae.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=Ae.Verbosity.ERROR&&console.error(e)}};function xs(s,e,t){var r=e[0],i=e[1],n=e[2],a=e[3],c=e[4],o=e[5],g=e[6],m=e[7],T=e[8],p=e[9],y=e[10],A=e[11],I=e[12],l=e[13],b=e[14],u=e[15],h=t[0],f=t[1],d=t[2],E=t[3];return s[0]=h*r+f*c+d*T+E*I,s[1]=h*i+f*o+d*p+E*l,s[2]=h*n+f*g+d*y+E*b,s[3]=h*a+f*m+d*A+E*u,s[4]=(h=t[4])*r+(f=t[5])*c+(d=t[6])*T+(E=t[7])*I,s[5]=h*i+f*o+d*p+E*l,s[6]=h*n+f*g+d*y+E*b,s[7]=h*a+f*m+d*A+E*u,s[8]=(h=t[8])*r+(f=t[9])*c+(d=t[10])*T+(E=t[11])*I,s[9]=h*i+f*o+d*p+E*l,s[10]=h*n+f*g+d*y+E*b,s[11]=h*a+f*m+d*A+E*u,s[12]=(h=t[12])*r+(f=t[13])*c+(d=t[14])*T+(E=t[15])*I,s[13]=h*i+f*o+d*p+E*l,s[14]=h*n+f*g+d*y+E*b,s[15]=h*a+f*m+d*A+E*u,s}rt=ie,ie.Verbosity=ht,ie.DEFAULT_INSTANCE=new rt(rt.Verbosity.INFO);class B{static identity(e){return e}static eq(e,t,r=1e-5){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(Math.abs(e[i]-t[i])>r)return!1;return!0}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static denormalize(e,t){return B.decodeNormalizedInt(e,t)}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(65535*e);case 5121:return Math.round(255*e);case 5122:return Math.round(32767*e);case 5120:return Math.round(127*e);default:throw new Error("Invalid component type.")}}static normalize(e,t){return B.encodeNormalizedInt(e,t)}static decompose(e,t,r,i){let n=st([e[0],e[1],e[2]]);const a=st([e[4],e[5],e[6]]),c=st([e[8],e[9],e[10]]);var o,g,m,T,p,y,A,I,l,b,u,h,f,d,E,x,N;((g=(o=e)[0])*(A=o[5])-(m=o[1])*(y=o[4]))*((h=o[10])*(N=o[15])-(f=o[11])*(x=o[14]))-(g*(I=o[6])-(T=o[2])*y)*((u=o[9])*N-f*(E=o[13]))+(g*(l=o[7])-(p=o[3])*y)*(u*x-h*E)+(m*I-T*A)*((b=o[8])*N-f*(d=o[12]))-(m*l-p*A)*(b*x-h*d)+(T*l-p*I)*(b*E-u*d)<0&&(n=-n),t[0]=e[12],t[1]=e[13],t[2]=e[14];const v=e.slice(),w=1/n,R=1/a,O=1/c;v[0]*=w,v[1]*=w,v[2]*=w,v[4]*=R,v[5]*=R,v[6]*=R,v[8]*=O,v[9]*=O,v[10]*=O,function(S,_){var V=new ut(3);(function(tt,J){var ps=J[4],ds=J[5],ms=J[6],ys=J[8],Es=J[9],Ts=J[10];tt[0]=Math.hypot(J[0],J[1],J[2]),tt[1]=Math.hypot(ps,ds,ms),tt[2]=Math.hypot(ys,Es,Ts)})(V,_);var P=1/V[0],j=1/V[1],D=1/V[2],k=_[0]*P,Z=_[1]*j,ae=_[2]*D,q=_[4]*P,Q=_[5]*j,ee=_[6]*D,Oe=_[8]*P,Ve=_[9]*j,oe=_[10]*D,vt=k+Q+oe,U=0;vt>0?(U=2*Math.sqrt(vt+1),S[3]=.25*U,S[0]=(ee-Ve)/U,S[1]=(Oe-ae)/U,S[2]=(Z-q)/U):k>Q&&k>oe?(U=2*Math.sqrt(1+k-Q-oe),S[3]=(ee-Ve)/U,S[0]=.25*U,S[1]=(Z+q)/U,S[2]=(Oe+ae)/U):Q>oe?(U=2*Math.sqrt(1+Q-k-oe),S[3]=(Oe-ae)/U,S[0]=(Z+q)/U,S[1]=.25*U,S[2]=(ee+Ve)/U):(U=2*Math.sqrt(1+oe-k-Q),S[3]=(Z-q)/U,S[0]=(Oe+ae)/U,S[1]=(ee+Ve)/U,S[2]=.25*U)}(r,v),i[0]=n,i[1]=a,i[2]=c}static compose(e,t,r,i){const n=i,a=t[0],c=t[1],o=t[2],g=t[3],m=a+a,T=c+c,p=o+o,y=a*m,A=a*T,I=a*p,l=c*T,b=c*p,u=o*p,h=g*m,f=g*T,d=g*p,E=r[0],x=r[1],N=r[2];return n[0]=(1-(l+u))*E,n[1]=(A+d)*E,n[2]=(I-f)*E,n[3]=0,n[4]=(A-d)*x,n[5]=(1-(y+u))*x,n[6]=(b+h)*x,n[7]=0,n[8]=(I+f)*N,n[9]=(b-h)*N,n[10]=(1-(y+l))*N,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}}function Ms(s,e){if(!!s!=!!e)return!1;const t=s.getChild(),r=e.getChild();return t===r||t.equals(r)}function _s(s,e){if(!!s!=!!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++){const r=s[t],i=e[t];if(r.getChild()!==i.getChild()&&!r.getChild().equals(i.getChild()))return!1}return!0}function Ns(s,e){if(!!s!=!!e)return!1;const t=Object.keys(s),r=Object.keys(e);if(t.length!==r.length)return!1;for(const i in s){const n=s[i],a=e[i];if(!!n!=!!a)return!1;const c=n.getChild(),o=a.getChild();if(c!==o&&!c.equals(o))return!1}return!0}function qt(s,e){if(s===e)return!0;if(!!s!=!!e||!s||!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function Wt(s,e){if(s===e)return!0;if(!!s!=!!e)return!1;if(!se(s)||!se(e))return s===e;const t=s,r=e;let i,n=0,a=0;for(i in t)n++;for(i in r)a++;if(n!==a)return!1;for(i in t){const c=t[i],o=r[i];if(qe(c)&&qe(o)){if(!qt(c,o))return!1}else if(se(c)&&se(o)){if(!Wt(c,o))return!1}else if(c!==o)return!1}return!0}function qe(s){return Array.isArray(s)||ArrayBuffer.isView(s)}const wt=new Set,Ss=function(){let s="";for(let e=0;e<6;e++)s+="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ".charAt(Math.floor(42*Math.random()));return s},Cs=function(){for(let s=0;s<999;s++){const e=Ss();if(!wt.has(e))return wt.add(e),e}return""},Rt="https://null.example";let Re=class{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return ge.basename(new URL(e,Rt).pathname)}static extension(e){return ge.extension(new URL(e,Rt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const r=e.split("/"),i=t.split("/");r.pop();for(let n=0;n<i.length;n++)i[n]!=="."&&(i[n]===".."?r.pop():r.push(i[n]));return r.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}};Re.DEFAULT_INIT={},Re.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const K=s=>s,Os=new Set;class Et extends yt{constructor(e,t=""){super(e),this[L].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){return new this.constructor(this.graph).copy(this,K)}copy(e,t=K){for(const r in this[L]){const i=this[L][r];if(i instanceof fe)this[le].has(r)||i.dispose();else if(Te(i))for(const n of i)n.dispose();else if(be(i))for(const n in i)i[n].dispose()}for(const r in e[L]){const i=this[L][r],n=e[L][r];if(n instanceof fe)this[le].has(r)?i.getChild().copy(t(n.getChild()),t):this.setRef(r,t(n.getChild()),n.getAttributes());else if(Te(n))for(const a of n)this.addRef(r,t(a.getChild()),a.getAttributes());else if(be(n))for(const a in n){const c=n[a];this.setRefMap(r,a,t(c.getChild()),c.getAttributes())}else this[L][r]=se(n)?JSON.parse(JSON.stringify(n)):Array.isArray(n)||n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.slice():n}return this}equals(e,t=Os){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const r in this[L]){if(t.has(r))continue;const i=this[L][r],n=e[L][r];if(ot(i)||ot(n)){if(!Ms(i,n))return!1}else if(Te(i)||Te(n)){if(!_s(i,n))return!1}else if(be(i)||be(n)){if(!Ns(i,n))return!1}else if(se(i)||se(n)){if(!Wt(i,n))return!1}else if(qe(i)||qe(n)){if(!qt(i,n))return!1}else if(i!==n)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}let z=class extends Et{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t.t(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}};class C extends z{constructor(...e){super(...e),this.i=B.identity,this.o=B.identity}init(){this.propertyType=M.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:C.Type.SCALAR,componentType:C.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}copy(e,t=K){return super.copy(e,t),this.i=e.i,this.o=e.o,this}static getElementSize(e){switch(e){case C.Type.SCALAR:return 1;case C.Type.VEC2:return 2;case C.Type.VEC3:return 3;case C.Type.VEC4:case C.Type.MAT2:return 4;case C.Type.MAT3:return 9;case C.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case C.ComponentType.BYTE:case C.ComponentType.UNSIGNED_BYTE:return 1;case C.ComponentType.SHORT:case C.ComponentType.UNSIGNED_SHORT:return 2;case C.ComponentType.UNSIGNED_INT:case C.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getElementSize();this.getMin(e);for(let r=0;r<t;r++)e[r]=this.o(e[r]);return e}getMin(e){const t=this.get("array"),r=this.getCount(),i=this.getElementSize();for(let n=0;n<i;n++)e[n]=1/0;for(let n=0;n<r*i;n+=i)for(let a=0;a<i;a++){const c=t[n+a];Number.isFinite(c)&&(e[a]=Math.min(e[a],c))}return e}getMaxNormalized(e){const t=this.getElementSize();this.getMax(e);for(let r=0;r<t;r++)e[r]=this.o(e[r]);return e}getMax(e){const t=this.get("array"),r=this.getCount(),i=this.getElementSize();for(let n=0;n<i;n++)e[n]=-1/0;for(let n=0;n<r*i;n+=i)for(let a=0;a<i;a++){const c=t[n+a];Number.isFinite(c)&&(e[a]=Math.max(e[a],c))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return C.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e),e?(this.o=t=>B.decodeNormalizedInt(t,this.get("componentType")),this.i=t=>B.encodeNormalizedInt(t,this.get("componentType"))):(this.o=B.identity,this.i=B.identity),this}getScalar(e){const t=this.getElementSize();return this.o(this.get("array")[e*t])}setScalar(e,t){return this.get("array")[e*this.getElementSize()]=this.i(t),this}getElement(e,t){const r=this.getElementSize(),i=this.get("array");for(let n=0;n<r;n++)t[n]=this.o(i[e*r+n]);return t}setElement(e,t){const r=this.getElementSize(),i=this.get("array");for(let n=0;n<r;n++)i[e*r+n]=this.i(t[n]);return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?function(t){switch(t.constructor){case Float32Array:return C.ComponentType.FLOAT;case Uint32Array:return C.ComponentType.UNSIGNED_INT;case Uint16Array:return C.ComponentType.UNSIGNED_SHORT;case Uint8Array:return C.ComponentType.UNSIGNED_BYTE;case Int16Array:return C.ComponentType.SHORT;case Int8Array:return C.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(e):C.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}C.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},C.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};let Yt=class extends z{init(){this.propertyType=M.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}};class Ke extends z{init(){this.propertyType=M.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}Ke.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Ne extends z{init(){this.propertyType=M.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ne.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:$.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:$.OTHER})}}Ne.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Ht extends z{init(){this.propertyType=M.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}let Se=class Xt extends z{init(){this.propertyType=M.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Xt.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}};Se.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class Ce extends Et{t(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}Ce.EXTENSION_NAME=void 0;let H=class ft extends z{init(){this.propertyType=M.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:ft.WrapMode.REPEAT,wrapT:ft.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}};H.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},H.MagFilter={NEAREST:9728,LINEAR:9729},H.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:Fe,G:Le,B:je,A:Vs}=ct;let pe=class Jt extends z{init(){this.propertyType=M.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:Jt.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new H(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new H(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new H(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new H(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new H(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorHex(){return ve.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(e){const t=this.get("baseColorFactor").slice();return this.set("baseColorFactor",ve.hexToFactor(e,t))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:Fe|Le|je|Vs,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveHex(){return ve.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(e){const t=this.get("emissiveFactor").slice();return this.set("emissiveFactor",ve.hexToFactor(e,t))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:Fe|Le|je,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:Fe|Le|je})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:Fe})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:Le|je})}};pe.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class Kt extends z{init(){this.propertyType=M.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}let Zt=class extends z{constructor(...e){super(...e),this.u=null,this.h=new Set}init(){this.propertyType=M.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(e,t=K){if(t===K)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return B.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),r=this.get("rotation").slice(),i=this.get("scale").slice();return B.decompose(e,t,r,i),this.set("translation",t).set("rotation",r).set("scale",i)}getWorldTranslation(){const e=[0,0,0];return B.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return B.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return B.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let i=this;i!=null;i=i.u)e.push(i);let t;const r=e.pop().getMatrix();for(;t=e.pop();)xs(r,r,t.getMatrix());return r}addChild(e){if(e.u&&e.u.removeChild(e),e.h.size)for(const r of e.h)r.removeChild(e);this.addRef("children",e),e.u=this;const t=this[L].children;return t[t.length-1].addEventListener("dispose",()=>e.u=null),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParent(){return this.u?this.u:this.listParents().find(e=>e.propertyType===M.SCENE)||null}getParentNode(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}},de=class Qt extends z{init(){this.propertyType=M.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:Qt.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:$.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:$.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}};de.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};let es=class extends Et{init(){this.propertyType=M.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:$.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}};function G(){return G=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},G.apply(this,arguments)}let Ze=class extends z{init(){this.propertyType=M.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(e,t=K){if(t===K)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.h.add(this);const t=this[L].children;return t[t.length-1].addEventListener("dispose",()=>e.h.delete(this)),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}};class ts extends z{init(){this.propertyType=M.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:$.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}let _e=class extends z{init(){this.propertyType=M.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||ne.extensionToMimeType(ge.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=ne.extensionToMimeType(ge.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",F.assertView(e))}getSize(){const e=this.get("image");return e?ne.getSize(e,this.getMimeType()):null}},ss=class extends z{init(){this.propertyType=M.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${$t}`,version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(e){super(e),this.l=new Set,e.addEventListener("node:create",t=>{this.g(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=K){if(t===K)throw new Error("Root cannot be copied.");this.set("asset",G({},e.get("asset"))),this.setName(e.getName()),this.setExtras(G({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const r of e.listRefMapKeys("extensions")){const i=e.getExtension(r);this.setExtension(r,t(i))}return this}g(e){return e instanceof Ze?this.addRef("scenes",e):e instanceof Zt?this.addRef("nodes",e):e instanceof Se?this.addRef("cameras",e):e instanceof ts?this.addRef("skins",e):e instanceof Kt?this.addRef("meshes",e):e instanceof pe?this.addRef("materials",e):e instanceof _e?this.addRef("textures",e):e instanceof Yt?this.addRef("animations",e):e instanceof C?this.addRef("accessors",e):e instanceof Ht&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.l)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}p(e){return this.l.add(e),this}m(e){return this.l.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}},Qe=class ke{static fromGraph(e){return ke.v.get(e)||null}constructor(){this.T=new bs,this.S=new ss(this.T),this.M=ie.DEFAULT_INSTANCE,ke.v.set(this.T,this)}getRoot(){return this.S}getGraph(){return this.T}getLogger(){return this.M}setLogger(e){return this.M=e,this}clone(){return new ke().setLogger(this.M).merge(this)}merge(e){for(const n of e.getRoot().listExtensionsUsed()){const a=this.createExtension(n.constructor);n.isRequired()&&a.setRequired(!0)}const t=new Set,r=new Map;t.add(e.S),r.set(e.S,this.S);for(const n of e.T.listEdges())for(const a of[n.getParent(),n.getChild()]){if(t.has(a))continue;let c;c=a.propertyType===M.TEXTURE_INFO?a:new a.constructor(this.T),r.set(a,c),t.add(a)}const i=n=>{const a=r.get(n);if(!a)throw new Error("Could resolve property.");return a};for(const n of t){const a=r.get(n);if(!a)throw new Error("Could resolve property.");a.propertyType!==M.TEXTURE_INFO&&a.copy(n,i)}return this}async transform(...e){const t=e.map(r=>r.name);for(const r of e)await r(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(r=>r.extensionName===t)||new e(this)}createScene(e=""){return new Ze(this.T,e)}createNode(e=""){return new Zt(this.T,e)}createCamera(e=""){return new Se(this.T,e)}createSkin(e=""){return new ts(this.T,e)}createMesh(e=""){return new Kt(this.T,e)}createPrimitive(){return new de(this.T)}createPrimitiveTarget(e=""){return new es(this.T,e)}createMaterial(e=""){return new pe(this.T,e)}createTexture(e=""){return new _e(this.T,e)}createAnimation(e=""){return new Yt(this.T,e)}createAnimationChannel(e=""){return new Ke(this.T,e)}createAnimationSampler(e=""){return new Ne(this.T,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new C(this.T,e).setBuffer(t)}createBuffer(e=""){return new Ht(this.T,e)}};Qe.v=new WeakMap;class rs{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.I=void 0,this.document=e,e.getRoot().p(this),this.I=r=>{const i=r,n=i.target;n instanceof Ce&&n.extensionName===this.extensionName&&(i.type==="node:create"&&this.N(n),i.type==="node:dispose"&&this.O(n))};const t=e.getGraph();t.addEventListener("node:create",this.I),t.addEventListener("node:dispose",this.I)}dispose(){this.document.getRoot().m(this);const e=this.document.getGraph();e.removeEventListener("node:create",this.I),e.removeEventListener("node:dispose",this.I);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}N(e){return this.properties.add(e),this}O(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}rs.EXTENSION_NAME=void 0;let Ps=class{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const r=this.jsonDoc.json.textures[t.index];if(r.sampler===void 0)return;const i=this.jsonDoc.json.samplers[r.sampler];i.magFilter!==void 0&&e.setMagFilter(i.magFilter),i.minFilter!==void 0&&e.setMinFilter(i.minFilter),i.wrapS!==void 0&&e.setWrapS(i.wrapS),i.wrapT!==void 0&&e.setWrapT(i.wrapT)}};const It={logger:ie.DEFAULT_INSTANCE,extensions:[],dependencies:{}};let Fs=class{static read(e,t=It){const r=G({},It,t),{json:i}=e,n=new Qe().setLogger(r.logger);this.validate(e,r);const a=new Ps(e),c=i.asset,o=n.getRoot().getAsset();c.copyright&&(o.copyright=c.copyright),c.extras&&(o.extras=c.extras),i.extras!==void 0&&n.getRoot().setExtras(G({},i.extras));const g=i.extensionsUsed||[],m=i.extensionsRequired||[];for(const u of r.extensions)if(g.includes(u.EXTENSION_NAME)){const h=n.createExtension(u).setRequired(m.includes(u.EXTENSION_NAME));for(const f of h.readDependencies)h.install(f,r.dependencies[f])}const T=i.buffers||[];n.getRoot().listExtensionsUsed().filter(u=>u.prereadTypes.includes(M.BUFFER)).forEach(u=>u.preread(a,M.BUFFER)),a.buffers=T.map(u=>{const h=n.createBuffer(u.name);return u.extras&&h.setExtras(u.extras),u.uri&&u.uri.indexOf("__")!==0&&h.setURI(u.uri),h}),a.bufferViewBuffers=(i.bufferViews||[]).map((u,h)=>{if(!a.bufferViews[h]){const f=e.json.buffers[u.buffer];a.bufferViews[h]=F.toView(f.uri?e.resources[f.uri]:e.resources[Ge],u.byteOffset||0,u.byteLength)}return a.buffers[u.buffer]});const p=i.accessors||[];a.accessors=p.map(u=>{const h=n.createAccessor(u.name,a.bufferViewBuffers[u.bufferView]).setType(u.type);return u.extras&&h.setExtras(u.extras),u.normalized!==void 0&&h.setNormalized(u.normalized),u.bufferView===void 0||h.setArray(Be(u,a)),h});const y=i.images||[],A=i.textures||[];n.getRoot().listExtensionsUsed().filter(u=>u.prereadTypes.includes(M.TEXTURE)).forEach(u=>u.preread(a,M.TEXTURE)),a.textures=y.map(u=>{const h=n.createTexture(u.name);if(u.extras&&h.setExtras(u.extras),u.bufferView!==void 0){const f=i.bufferViews[u.bufferView],d=e.json.buffers[f.buffer],E=f.byteOffset||0,x=(d.uri?e.resources[d.uri]:e.resources[Ge]).slice(E,E+f.byteLength);h.setImage(x)}else u.uri!==void 0&&(h.setImage(e.resources[u.uri]),u.uri.indexOf("__")!==0&&h.setURI(u.uri));if(u.mimeType!==void 0)h.setMimeType(u.mimeType);else if(u.uri){const f=ge.extension(u.uri);h.setMimeType(ne.extensionToMimeType(f))}return h}),a.materials=(i.materials||[]).map(u=>{const h=n.createMaterial(u.name);u.extras&&h.setExtras(u.extras),u.alphaMode!==void 0&&h.setAlphaMode(u.alphaMode),u.alphaCutoff!==void 0&&h.setAlphaCutoff(u.alphaCutoff),u.doubleSided!==void 0&&h.setDoubleSided(u.doubleSided);const f=u.pbrMetallicRoughness||{};if(f.baseColorFactor!==void 0&&h.setBaseColorFactor(f.baseColorFactor),u.emissiveFactor!==void 0&&h.setEmissiveFactor(u.emissiveFactor),f.metallicFactor!==void 0&&h.setMetallicFactor(f.metallicFactor),f.roughnessFactor!==void 0&&h.setRoughnessFactor(f.roughnessFactor),f.baseColorTexture!==void 0){const d=f.baseColorTexture;h.setBaseColorTexture(a.textures[A[d.index].source]),a.setTextureInfo(h.getBaseColorTextureInfo(),d)}if(u.emissiveTexture!==void 0){const d=u.emissiveTexture;h.setEmissiveTexture(a.textures[A[d.index].source]),a.setTextureInfo(h.getEmissiveTextureInfo(),d)}if(u.normalTexture!==void 0){const d=u.normalTexture;h.setNormalTexture(a.textures[A[d.index].source]),a.setTextureInfo(h.getNormalTextureInfo(),d),u.normalTexture.scale!==void 0&&h.setNormalScale(u.normalTexture.scale)}if(u.occlusionTexture!==void 0){const d=u.occlusionTexture;h.setOcclusionTexture(a.textures[A[d.index].source]),a.setTextureInfo(h.getOcclusionTextureInfo(),d),u.occlusionTexture.strength!==void 0&&h.setOcclusionStrength(u.occlusionTexture.strength)}if(f.metallicRoughnessTexture!==void 0){const d=f.metallicRoughnessTexture;h.setMetallicRoughnessTexture(a.textures[A[d.index].source]),a.setTextureInfo(h.getMetallicRoughnessTextureInfo(),d)}return h});const I=i.meshes||[];n.getRoot().listExtensionsUsed().filter(u=>u.prereadTypes.includes(M.PRIMITIVE)).forEach(u=>u.preread(a,M.PRIMITIVE)),a.meshes=I.map(u=>{const h=n.createMesh(u.name);return u.extras&&h.setExtras(u.extras),u.weights!==void 0&&h.setWeights(u.weights),(u.primitives||[]).forEach(f=>{const d=n.createPrimitive();f.extras&&d.setExtras(f.extras),f.material!==void 0&&d.setMaterial(a.materials[f.material]),f.mode!==void 0&&d.setMode(f.mode);for(const[x,N]of Object.entries(f.attributes||{}))d.setAttribute(x,a.accessors[N]);f.indices!==void 0&&d.setIndices(a.accessors[f.indices]);const E=u.extras&&u.extras.targetNames||[];(f.targets||[]).forEach((x,N)=>{const v=E[N]||N.toString(),w=n.createPrimitiveTarget(v);for(const[R,O]of Object.entries(x))w.setAttribute(R,a.accessors[O]);d.addTarget(w)}),h.addPrimitive(d)}),h}),a.cameras=(i.cameras||[]).map(u=>{const h=n.createCamera(u.name).setType(u.type);if(u.extras&&h.setExtras(u.extras),u.type===Se.Type.PERSPECTIVE){const f=u.perspective;h.setYFov(f.yfov),h.setZNear(f.znear),f.zfar!==void 0&&h.setZFar(f.zfar),f.aspectRatio!==void 0&&h.setAspectRatio(f.aspectRatio)}else{const f=u.orthographic;h.setZNear(f.znear).setZFar(f.zfar).setXMag(f.xmag).setYMag(f.ymag)}return h});const l=i.nodes||[];n.getRoot().listExtensionsUsed().filter(u=>u.prereadTypes.includes(M.NODE)).forEach(u=>u.preread(a,M.NODE)),a.nodes=l.map(u=>{const h=n.createNode(u.name);if(u.extras&&h.setExtras(u.extras),u.translation!==void 0&&h.setTranslation(u.translation),u.rotation!==void 0&&h.setRotation(u.rotation),u.scale!==void 0&&h.setScale(u.scale),u.matrix!==void 0){const f=[0,0,0],d=[0,0,0,1],E=[1,1,1];B.decompose(u.matrix,f,d,E),h.setTranslation(f),h.setRotation(d),h.setScale(E)}return u.weights!==void 0&&h.setWeights(u.weights),h}),a.skins=(i.skins||[]).map(u=>{const h=n.createSkin(u.name);u.extras&&h.setExtras(u.extras),u.inverseBindMatrices!==void 0&&h.setInverseBindMatrices(a.accessors[u.inverseBindMatrices]),u.skeleton!==void 0&&h.setSkeleton(a.nodes[u.skeleton]);for(const f of u.joints)h.addJoint(a.nodes[f]);return h}),l.map((u,h)=>{const f=a.nodes[h];(u.children||[]).forEach(d=>f.addChild(a.nodes[d])),u.mesh!==void 0&&f.setMesh(a.meshes[u.mesh]),u.camera!==void 0&&f.setCamera(a.cameras[u.camera]),u.skin!==void 0&&f.setSkin(a.skins[u.skin])}),a.animations=(i.animations||[]).map(u=>{const h=n.createAnimation(u.name);u.extras&&h.setExtras(u.extras);const f=(u.samplers||[]).map(d=>{const E=n.createAnimationSampler().setInput(a.accessors[d.input]).setOutput(a.accessors[d.output]).setInterpolation(d.interpolation||Ne.Interpolation.LINEAR);return d.extras&&E.setExtras(d.extras),h.addSampler(E),E});return(u.channels||[]).forEach(d=>{const E=n.createAnimationChannel().setSampler(f[d.sampler]).setTargetPath(d.target.path);d.target.node!==void 0&&E.setTargetNode(a.nodes[d.target.node]),d.extras&&E.setExtras(d.extras),h.addChannel(E)}),h});const b=i.scenes||[];return n.getRoot().listExtensionsUsed().filter(u=>u.prereadTypes.includes(M.SCENE)).forEach(u=>u.preread(a,M.SCENE)),a.scenes=b.map(u=>{const h=n.createScene(u.name);return u.extras&&h.setExtras(u.extras),(u.nodes||[]).map(f=>a.nodes[f]).forEach(f=>h.addChild(f)),h}),i.scene!==void 0&&n.getRoot().setDefaultScene(a.scenes[i.scene]),n.getRoot().listExtensionsUsed().forEach(u=>u.read(a)),p.forEach((u,h)=>{const f=a.accessors[h],d=!!u.sparse,E=!u.bufferView&&!f.getArray();(d||E)&&f.setSparse(!0).setArray(function(x,N){const v=$e[x.componentType],w=C.getElementSize(x.type);let R;R=x.bufferView!==void 0?Be(x,N):new v(x.count*w);const O=x.sparse;if(!O)return R;const S=O.count,_=G({},x,O.indices,{count:S,type:"SCALAR"}),V=G({},x,O.values,{count:S}),P=Be(_,N),j=Be(V,N);for(let D=0;D<_.count;D++)for(let k=0;k<w;k++)R[P[D]*w+k]=j[D*w+k];return R}(u,a))}),n}static validate(e,t){const r=e.json;if(r.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${r.asset.version}".`);if(r.extensionsRequired){for(const i of r.extensionsRequired)if(!t.extensions.find(n=>n.EXTENSION_NAME===i))throw new Error(`Missing required extension, "${i}".`)}if(r.extensionsUsed)for(const i of r.extensionsUsed)t.extensions.find(n=>n.EXTENSION_NAME===i)||t.logger.warn(`Missing optional extension, "${i}".`)}};function Be(s,e){const t=e.bufferViews[s.bufferView],r=e.jsonDoc.json.bufferViews[s.bufferView],i=$e[s.componentType],n=C.getElementSize(s.type),a=i.BYTES_PER_ELEMENT;if(r.byteStride!==void 0&&r.byteStride!==n*a)return function(o,g){const m=g.bufferViews[o.bufferView],T=g.jsonDoc.json.bufferViews[o.bufferView],p=$e[o.componentType],y=C.getElementSize(o.type),A=p.BYTES_PER_ELEMENT,I=o.byteOffset||0,l=new p(o.count*y),b=new DataView(m.buffer,m.byteOffset,m.byteLength),u=T.byteStride;for(let h=0;h<o.count;h++)for(let f=0;f<y;f++){const d=I+h*u+f*A;let E;switch(o.componentType){case C.ComponentType.FLOAT:E=b.getFloat32(d,!0);break;case C.ComponentType.UNSIGNED_INT:E=b.getUint32(d,!0);break;case C.ComponentType.UNSIGNED_SHORT:E=b.getUint16(d,!0);break;case C.ComponentType.UNSIGNED_BYTE:E=b.getUint8(d);break;case C.ComponentType.SHORT:E=b.getInt16(d,!0);break;case C.ComponentType.BYTE:E=b.getInt8(d);break;default:throw new Error(`Unexpected componentType "${o.componentType}".`)}l[h*y+f]=E}return l}(s,e);const c=t.byteOffset+(s.byteOffset||0);return new i(t.buffer.slice(c,c+s.count*n*a))}var Ie;(function(s){s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Ie||(Ie={}));class te{constructor(e,t,r){this.C=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.F=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.C=e,this.jsonDoc=t,this.options=r;const i=e.getRoot(),n=i.listBuffers().length,a=i.listTextures().length;this.bufferURIGenerator=new xt(n>1,()=>r.basename||"buffer"),this.imageURIGenerator=new xt(a>1,c=>function(o,g){const m=o.getGraph().listParentEdges(g).find(T=>T.getParent()!==o.getRoot());return m?m.getName().replace(/texture$/i,""):""}(e,c)||r.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const r={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},i=JSON.stringify(r);this.samplerDefIndexMap.has(i)||(this.samplerDefIndexMap.set(i,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(r));const n={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(i)},a=JSON.stringify(n);this.textureDefIndexMap.has(a)||(this.textureDefIndexMap.set(a,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(n));const c={index:this.textureDefIndexMap.get(a)};return t.getTexCoord()!==0&&(c.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(c.extras=t.getExtras()),this.textureInfoDefMap.set(t,c),c}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this.C.getGraph().listParentEdges(e).some(r=>r.getName()==="attributes"&&r.getAttributes().key==="POSITION"||r.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,r){if(this.options.format===re.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const i=ne.mimeTypeToExtension(r.getMimeType());e.uri=this.imageURIGenerator.createURI(r,i),this.jsonDoc.resources[e.uri]=t}}getAccessorUsage(e){const t=this.F.get(e);if(t)return t;if(e.getSparse())return $.SPARSE;for(const r of this.C.getGraph().listParentEdges(e)){const{usage:i}=r.getAttributes();if(i)return i;r.getParent().propertyType!==M.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${r.getName()}".`)}return $.OTHER}addAccessorToUsageGroup(e,t){const r=this.F.get(e);if(r&&r!==t)throw new Error(`Accessor with usage "${r}" cannot be reused as "${t}".`);return this.F.set(e,t),this}listAccessorUsageGroups(){const e={};for(const[t,r]of Array.from(this.F.entries()))e[r]=e[r]||[],e[r].push(t);return e}}te.BufferViewTarget=Ie,te.BufferViewUsage=$,te.USAGE_TO_TARGET={[$.ARRAY_BUFFER]:Ie.ARRAY_BUFFER,[$.ELEMENT_ARRAY_BUFFER]:Ie.ELEMENT_ARRAY_BUFFER};let xt=class{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const r=this.basename(e);return this.counter[r]=this.counter[r]||1,`${r}_${this.counter[r]++}.${t}`}return`${this.basename(e)}.${t}`}};const{BufferViewUsage:Ue}=te,{UNSIGNED_INT:Ls,UNSIGNED_SHORT:js,UNSIGNED_BYTE:Bs}=C.ComponentType;let Us=class{static write(e,t){const r=e.getRoot(),i={asset:G({generator:`glTF-Transform ${$t}`},r.getAsset()),extras:G({},r.getExtras())},n={json:i,resources:{}},a=new te(e,n,t),c=t.logger||ie.DEFAULT_INSTANCE,o=new Set(t.extensions.map(l=>l.EXTENSION_NAME)),g=e.getRoot().listExtensionsUsed().filter(l=>o.has(l.extensionName)),m=e.getRoot().listExtensionsRequired().filter(l=>o.has(l.extensionName));g.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const l of g)for(const b of l.writeDependencies)l.install(b,t.dependencies[b]);function T(l,b,u,h){const f=[];let d=0;for(const x of l){const N=a.createAccessorDef(x);N.bufferView=i.bufferViews.length;const v=x.getArray(),w=F.pad(F.toView(v));N.byteOffset=d,d+=w.byteLength,f.push(w),a.accessorIndexMap.set(x,i.accessors.length),i.accessors.push(N)}const E={buffer:b,byteOffset:u,byteLength:F.concat(f).byteLength};return h&&(E.target=h),i.bufferViews.push(E),{buffers:f,byteLength:d}}function p(l,b,u){const h=l[0].getCount();let f=0;for(const N of l){const v=a.createAccessorDef(N);v.bufferView=i.bufferViews.length,v.byteOffset=f;const w=N.getElementSize(),R=N.getComponentSize();f+=F.padNumber(w*R),a.accessorIndexMap.set(N,i.accessors.length),i.accessors.push(v)}const d=h*f,E=new ArrayBuffer(d),x=new DataView(E);for(let N=0;N<h;N++){let v=0;for(const w of l){const R=w.getElementSize(),O=w.getComponentSize(),S=w.getComponentType(),_=w.getArray();for(let V=0;V<R;V++){const P=N*f+v+V*O,j=_[N*R+V];switch(S){case C.ComponentType.FLOAT:x.setFloat32(P,j,!0);break;case C.ComponentType.BYTE:x.setInt8(P,j);break;case C.ComponentType.SHORT:x.setInt16(P,j,!0);break;case C.ComponentType.UNSIGNED_BYTE:x.setUint8(P,j);break;case C.ComponentType.UNSIGNED_SHORT:x.setUint16(P,j,!0);break;case C.ComponentType.UNSIGNED_INT:x.setUint32(P,j,!0);break;default:throw new Error("Unexpected component type: "+S)}}v+=F.padNumber(R*O)}}return i.bufferViews.push({buffer:b,byteOffset:u,byteLength:d,byteStride:f,target:te.BufferViewTarget.ARRAY_BUFFER}),{byteLength:d,buffers:[new Uint8Array(E)]}}function y(l,b,u){const h=[];let f=0;const d=new Map;let E=-1/0;for(const S of l){const _=a.createAccessorDef(S);i.accessors.push(_),a.accessorIndexMap.set(S,i.accessors.length-1);const V=[],P=[],j=[],D=new Array(S.getElementSize()).fill(0);for(let q=0,Q=S.getCount();q<Q;q++)if(S.getElement(q,j),!B.eq(j,D,0)){E=Math.max(q,E),V.push(q);for(let ee=0;ee<j.length;ee++)P.push(j[ee])}const k=V.length,Z={accessorDef:_,count:k};if(d.set(S,Z),k===0)continue;if(k>S.getCount()/3){const q=(100*V.length/S.getCount()).toFixed(1);c.warn(`Sparse accessor with many non-zero elements (${q}%) may increase file size.`)}const ae=$e[S.getComponentType()];Z.indices=V,Z.values=new ae(P)}if(!Number.isFinite(E))return{buffers:h,byteLength:f};const x=E<255?Uint8Array:E<65535?Uint16Array:Uint32Array,N=E<255?Bs:E<65535?js:Ls,v={buffer:b,byteOffset:u+f,byteLength:0};for(const S of l){const _=d.get(S);if(_.count===0)continue;_.indicesByteOffset=v.byteLength;const V=F.pad(F.toView(new x(_.indices)));h.push(V),f+=V.byteLength,v.byteLength+=V.byteLength}i.bufferViews.push(v);const w=i.bufferViews.length-1,R={buffer:b,byteOffset:u+f,byteLength:0};for(const S of l){const _=d.get(S);if(_.count===0)continue;_.valuesByteOffset=R.byteLength;const V=F.pad(F.toView(_.values));h.push(V),f+=V.byteLength,R.byteLength+=V.byteLength}i.bufferViews.push(R);const O=i.bufferViews.length-1;for(const S of l){const _=d.get(S);_.count!==0&&(_.accessorDef.sparse={count:_.count,indices:{bufferView:w,byteOffset:_.indicesByteOffset,componentType:N},values:{bufferView:O,byteOffset:_.valuesByteOffset}})}return{buffers:h,byteLength:f}}const A=new Map;for(const l of e.getGraph().listEdges()){if(l.getParent()===r)continue;const b=l.getChild();if(b instanceof C){const u=A.get(b)||[];u.push(l),A.set(b,u)}}if(i.accessors=[],i.bufferViews=[],i.samplers=[],i.textures=[],i.images=r.listTextures().map((l,b)=>{const u=a.createPropertyDef(l);l.getMimeType()&&(u.mimeType=l.getMimeType());const h=l.getImage();return h&&a.createImageData(u,h,l),a.imageIndexMap.set(l,b),u}),g.filter(l=>l.prewriteTypes.includes(M.ACCESSOR)).forEach(l=>l.prewrite(a,M.ACCESSOR)),r.listAccessors().forEach(l=>{const b=a.accessorUsageGroupedByParent,u=a.accessorParents;if(a.accessorIndexMap.has(l))return;const h=A.get(l)||[],f=a.getAccessorUsage(l);if(a.addAccessorToUsageGroup(l,f),b.has(f)){const d=h[0].getParent(),E=u.get(d)||new Set;E.add(l),u.set(d,E)}}),g.filter(l=>l.prewriteTypes.includes(M.BUFFER)).forEach(l=>l.prewrite(a,M.BUFFER)),(r.listAccessors().length>0||r.listTextures().length>0||a.otherBufferViews.size>0)&&r.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");i.buffers=[],r.listBuffers().forEach((l,b)=>{const u=a.createPropertyDef(l),h=a.accessorUsageGroupedByParent,f=a.accessorParents,d=l.listParents().filter(R=>R instanceof C),E=new Set(d),x=[],N=i.buffers.length;let v=0;const w=a.listAccessorUsageGroups();for(const R in w)if(h.has(R))for(const O of Array.from(f.values())){const S=Array.from(O).filter(_=>E.has(_)).filter(_=>a.getAccessorUsage(_)===R);if(S.length)if(R!==Ue.ARRAY_BUFFER||t.vertexLayout===ze.INTERLEAVED){const _=R===Ue.ARRAY_BUFFER?p(S,N,v):T(S,N,v);v+=_.byteLength,x.push(..._.buffers)}else for(const _ of S){const V=p([_],N,v);v+=V.byteLength,x.push(...V.buffers)}}else{const O=w[R].filter(V=>E.has(V));if(!O.length)continue;const S=R===Ue.ELEMENT_ARRAY_BUFFER?te.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0,_=R===Ue.SPARSE?y(O,N,v):T(O,N,v,S);v+=_.byteLength,x.push(..._.buffers)}if(a.imageBufferViews.length&&b===0){for(let R=0;R<a.imageBufferViews.length;R++)if(i.bufferViews[i.images[R].bufferView].byteOffset=v,v+=a.imageBufferViews[R].byteLength,x.push(a.imageBufferViews[R]),v%8){const O=8-v%8;v+=O,x.push(new Uint8Array(O))}}if(a.otherBufferViews.has(l))for(const R of a.otherBufferViews.get(l))i.bufferViews.push({buffer:N,byteOffset:v,byteLength:R.byteLength}),a.otherBufferViewsIndexMap.set(R,i.bufferViews.length-1),v+=R.byteLength,x.push(R);if(v){let R;t.format===re.GLB?R=Ge:(R=a.bufferURIGenerator.createURI(l,"bin"),u.uri=R),u.byteLength=v,n.resources[R]=F.concat(x)}i.buffers.push(u),a.bufferIndexMap.set(l,b)}),r.listAccessors().find(l=>!l.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),i.materials=r.listMaterials().map((l,b)=>{const u=a.createPropertyDef(l);if(l.getAlphaMode()!==pe.AlphaMode.OPAQUE&&(u.alphaMode=l.getAlphaMode()),l.getAlphaMode()===pe.AlphaMode.MASK&&(u.alphaCutoff=l.getAlphaCutoff()),l.getDoubleSided()&&(u.doubleSided=!0),u.pbrMetallicRoughness={},B.eq(l.getBaseColorFactor(),[1,1,1,1])||(u.pbrMetallicRoughness.baseColorFactor=l.getBaseColorFactor()),B.eq(l.getEmissiveFactor(),[0,0,0])||(u.emissiveFactor=l.getEmissiveFactor()),l.getRoughnessFactor()!==1&&(u.pbrMetallicRoughness.roughnessFactor=l.getRoughnessFactor()),l.getMetallicFactor()!==1&&(u.pbrMetallicRoughness.metallicFactor=l.getMetallicFactor()),l.getBaseColorTexture()){const h=l.getBaseColorTexture(),f=l.getBaseColorTextureInfo();u.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(h,f)}if(l.getEmissiveTexture()){const h=l.getEmissiveTexture(),f=l.getEmissiveTextureInfo();u.emissiveTexture=a.createTextureInfoDef(h,f)}if(l.getNormalTexture()){const h=l.getNormalTexture(),f=l.getNormalTextureInfo(),d=a.createTextureInfoDef(h,f);l.getNormalScale()!==1&&(d.scale=l.getNormalScale()),u.normalTexture=d}if(l.getOcclusionTexture()){const h=l.getOcclusionTexture(),f=l.getOcclusionTextureInfo(),d=a.createTextureInfoDef(h,f);l.getOcclusionStrength()!==1&&(d.strength=l.getOcclusionStrength()),u.occlusionTexture=d}if(l.getMetallicRoughnessTexture()){const h=l.getMetallicRoughnessTexture(),f=l.getMetallicRoughnessTextureInfo();u.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(h,f)}return a.materialIndexMap.set(l,b),u}),i.meshes=r.listMeshes().map((l,b)=>{const u=a.createPropertyDef(l);let h=null;return u.primitives=l.listPrimitives().map(f=>{const d={attributes:{}};d.mode=f.getMode();const E=f.getMaterial();E&&(d.material=a.materialIndexMap.get(E)),Object.keys(f.getExtras()).length&&(d.extras=f.getExtras());const x=f.getIndices();x&&(d.indices=a.accessorIndexMap.get(x));for(const N of f.listSemantics())d.attributes[N]=a.accessorIndexMap.get(f.getAttribute(N));for(const N of f.listTargets()){const v={};for(const w of N.listSemantics())v[w]=a.accessorIndexMap.get(N.getAttribute(w));d.targets=d.targets||[],d.targets.push(v)}return f.listTargets().length&&!h&&(h=f.listTargets().map(N=>N.getName())),d}),l.getWeights().length&&(u.weights=l.getWeights()),h&&(u.extras=u.extras||{},u.extras.targetNames=h),a.meshIndexMap.set(l,b),u}),i.cameras=r.listCameras().map((l,b)=>{const u=a.createPropertyDef(l);if(u.type=l.getType(),u.type===Se.Type.PERSPECTIVE){u.perspective={znear:l.getZNear(),zfar:l.getZFar(),yfov:l.getYFov()};const h=l.getAspectRatio();h!==null&&(u.perspective.aspectRatio=h)}else u.orthographic={znear:l.getZNear(),zfar:l.getZFar(),xmag:l.getXMag(),ymag:l.getYMag()};return a.cameraIndexMap.set(l,b),u}),i.nodes=r.listNodes().map((l,b)=>{const u=a.createPropertyDef(l);return B.eq(l.getTranslation(),[0,0,0])||(u.translation=l.getTranslation()),B.eq(l.getRotation(),[0,0,0,1])||(u.rotation=l.getRotation()),B.eq(l.getScale(),[1,1,1])||(u.scale=l.getScale()),l.getWeights().length&&(u.weights=l.getWeights()),a.nodeIndexMap.set(l,b),u}),i.skins=r.listSkins().map((l,b)=>{const u=a.createPropertyDef(l),h=l.getInverseBindMatrices();h&&(u.inverseBindMatrices=a.accessorIndexMap.get(h));const f=l.getSkeleton();return f&&(u.skeleton=a.nodeIndexMap.get(f)),u.joints=l.listJoints().map(d=>a.nodeIndexMap.get(d)),a.skinIndexMap.set(l,b),u}),r.listNodes().forEach((l,b)=>{const u=i.nodes[b],h=l.getMesh();h&&(u.mesh=a.meshIndexMap.get(h));const f=l.getCamera();f&&(u.camera=a.cameraIndexMap.get(f));const d=l.getSkin();d&&(u.skin=a.skinIndexMap.get(d)),l.listChildren().length>0&&(u.children=l.listChildren().map(E=>a.nodeIndexMap.get(E)))}),i.animations=r.listAnimations().map((l,b)=>{const u=a.createPropertyDef(l),h=new Map;return u.samplers=l.listSamplers().map((f,d)=>{const E=a.createPropertyDef(f);return E.input=a.accessorIndexMap.get(f.getInput()),E.output=a.accessorIndexMap.get(f.getOutput()),E.interpolation=f.getInterpolation(),h.set(f,d),E}),u.channels=l.listChannels().map(f=>{const d=a.createPropertyDef(f);return d.sampler=h.get(f.getSampler()),d.target={node:a.nodeIndexMap.get(f.getTargetNode()),path:f.getTargetPath()},d}),a.animationIndexMap.set(l,b),u}),i.scenes=r.listScenes().map((l,b)=>{const u=a.createPropertyDef(l);return u.nodes=l.listChildren().map(h=>a.nodeIndexMap.get(h)),a.sceneIndexMap.set(l,b),u});const I=r.getDefaultScene();return I&&(i.scene=r.listScenes().indexOf(I)),i.extensionsUsed=g.map(l=>l.extensionName),i.extensionsRequired=m.map(l=>l.extensionName),g.forEach(l=>l.write(a)),function(l){const b=[];for(const u in l){const h=l[u];(Array.isArray(h)&&h.length===0||h===null||h===""||h&&typeof h=="object"&&Object.keys(h).length===0)&&b.push(u)}for(const u of b)delete l[u]}(i),n}};var We;(function(s){s[s.JSON=1313821514]="JSON",s[s.BIN=5130562]="BIN"})(We||(We={}));let Ds=class{constructor(){this.M=ie.DEFAULT_INSTANCE,this.l=new Set,this.U={},this.P=ze.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this.M=e,this}registerExtensions(e){for(const t of e)this.l.add(t),t.register();return this}registerDependencies(e){return Object.assign(this.U,e),this}setVertexLayout(e){return this.P=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const r=Mt(t)?this.L(t):{json:JSON.parse(F.decodeText(t)),resources:{}};return await this.j(r,this.dirname(e)),this.D(r),r}async readJSON(e){return e=this._(e),this.D(e),Fs.read(e,{extensions:Array.from(this.l),dependencies:this.U,logger:this.M})}async binaryToJSON(e){const t=this.L(F.assertView(e));this.D(t);const r=t.json;if(r.buffers&&r.buffers.some(i=>function(n,a){return a.uri!==void 0&&!(a.uri in n.resources)}(t,i)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(r.images&&r.images.some(i=>function(n,a){return a.uri!==void 0&&!(a.uri in n.resources)&&a.bufferView===void 0}(t,i)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(F.assertView(e)))}async writeJSON(e,t={}){if(t.format===re.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return Us.write(e,{format:t.format||re.GLTF,basename:t.basename||"",logger:this.M,vertexLayout:this.P,dependencies:G({},this.U),extensions:Array.from(this.l)})}async writeBinary(e){const{json:t,resources:r}=await this.writeJSON(e,{format:re.GLB}),i=new Uint32Array([1179937895,2,12]),n=JSON.stringify(t),a=F.pad(F.encodeText(n),32),c=F.toView(new Uint32Array([a.byteLength,1313821514])),o=F.concat([c,a]);i[i.length-1]+=o.byteLength;const g=Object.values(r)[0];if(!g||!g.byteLength)return F.concat([F.toView(i),o]);const m=F.pad(g,0),T=F.toView(new Uint32Array([m.byteLength,5130562])),p=F.concat([T,m]);return i[i.length-1]+=p.byteLength,F.concat([F.toView(i),o,p])}async j(e,t){var r=this;const i=[...e.json.images||[],...e.json.buffers||[]].map(async function(n){const a=n.uri;if(!a||a.match(/data:/))return Promise.resolve();e.resources[a]=await r.readURI(r.resolve(t,a),"view"),r.lastReadBytes+=e.resources[a].byteLength});await Promise.all(i)}D(e){function t(r){if(r.uri){if(r.uri in e.resources)F.assertView(e.resources[r.uri]);else if(r.uri.match(/data:/)){const i=`__${Cs()}.${ge.extension(r.uri)}`;e.resources[i]=F.createBufferFromDataURI(r.uri),r.uri=i}}}(e.json.images||[]).forEach(r=>{if(r.bufferView===void 0&&r.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(r)}),(e.json.buffers||[]).forEach(t)}_(e){const{images:t,buffers:r}=e.json;return e={json:G({},e.json),resources:G({},e.resources)},t&&(e.json.images=t.map(i=>G({},i))),r&&(e.json.buffers=r.map(i=>G({},i))),e}L(e){if(!Mt(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==We.JSON)throw new Error("Missing required GLB JSON chunk.");const r=t[0],i=F.decodeText(F.toView(e,20,r)),n=JSON.parse(i),a=20+r;if(e.byteLength<=a)return{json:n,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==We.BIN)throw new Error("Expected GLB BIN in second chunk.");const o=F.toView(e,a+8,c[0]);return{json:n,resources:{[Ge]:o}}}};function Mt(s){if(s.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(s.buffer,s.byteOffset,3);return e[0]===1179937895&&e[1]===2}let hn=class extends Ds{constructor(e=Re.DEFAULT_INIT){super(),this.J=void 0,this.J=e}async readURI(e,t){const r=await fetch(e,this.J);switch(t){case"view":return new Uint8Array(await r.arrayBuffer());case"text":return r.text()}}resolve(e,t){return Re.resolve(e,t)}dirname(e){return Re.dirname(e)}};function ks(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Gs(s){for(var e=new Array(s),t=0;t<s;++t)e[t]=t;return e}var zs=Gs;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var $s=function(s){return s!=null&&(ns(s)||qs(s)||!!s._isBuffer)};function ns(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function qs(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&ns(s.slice(0,0))}var Ws=zs,Ys=$s,Hs=typeof Float64Array<"u";function Xs(s,e){return s[0]-e[0]}function Js(){var s=this.stride,e=new Array(s.length),t;for(t=0;t<e.length;++t)e[t]=[Math.abs(s[t]),t];e.sort(Xs);var r=new Array(e.length);for(t=0;t<r.length;++t)r[t]=e[t][1];return r}function Ks(s,e){var t=["View",e,"d",s].join("");e<0&&(t="View_Nil"+s);var r=s==="generic";if(e===-1){var i="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+s+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}",I=new Function(i);return I()}else if(e===0){var i="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+s+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}",I=new Function("TrivialArray",i);return I(Ye[s][0])}var i=["'use strict'"],n=Ws(e),a=n.map(function(l){return"i"+l}),c="this.offset+"+n.map(function(l){return"this.stride["+l+"]*i"+l}).join("+"),o=n.map(function(l){return"b"+l}).join(","),g=n.map(function(l){return"c"+l}).join(",");i.push("function "+t+"(a,"+o+","+g+",d){this.data=a","this.shape=["+o+"]","this.stride=["+g+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+s+"'","proto.dimension="+e),i.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+n.map(function(l){return"this.shape["+l+"]"}).join("*"),"}})"),e===1?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),e<4?(i.push("function "+t+"_order(){"),e===2?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):e===3&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+t+"_set("+a.join(",")+",v){"),r?i.push("return this.data.set("+c+",v)}"):i.push("return this.data["+c+"]=v}"),i.push("proto.get=function "+t+"_get("+a.join(",")+"){"),r?i.push("return this.data.get("+c+")}"):i.push("return this.data["+c+"]}"),i.push("proto.index=function "+t+"_index(",a.join(),"){return "+c+"}"),i.push("proto.hi=function "+t+"_hi("+a.join(",")+"){return new "+t+"(this.data,"+n.map(function(l){return["(typeof i",l,"!=='number'||i",l,"<0)?this.shape[",l,"]:i",l,"|0"].join("")}).join(",")+","+n.map(function(l){return"this.stride["+l+"]"}).join(",")+",this.offset)}");var m=n.map(function(l){return"a"+l+"=this.shape["+l+"]"}),T=n.map(function(l){return"c"+l+"=this.stride["+l+"]"});i.push("proto.lo=function "+t+"_lo("+a.join(",")+"){var b=this.offset,d=0,"+m.join(",")+","+T.join(","));for(var p=0;p<e;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){d=i"+p+"|0;b+=c"+p+"*d;a"+p+"-=d}");i.push("return new "+t+"(this.data,"+n.map(function(l){return"a"+l}).join(",")+","+n.map(function(l){return"c"+l}).join(",")+",b)}"),i.push("proto.step=function "+t+"_step("+a.join(",")+"){var "+n.map(function(l){return"a"+l+"=this.shape["+l+"]"}).join(",")+","+n.map(function(l){return"b"+l+"=this.stride["+l+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var p=0;p<e;++p)i.push("if(typeof i"+p+"==='number'){d=i"+p+"|0;if(d<0){c+=b"+p+"*(a"+p+"-1);a"+p+"=ceil(-a"+p+"/d)}else{a"+p+"=ceil(a"+p+"/d)}b"+p+"*=d}");i.push("return new "+t+"(this.data,"+n.map(function(l){return"a"+l}).join(",")+","+n.map(function(l){return"b"+l}).join(",")+",c)}");for(var y=new Array(e),A=new Array(e),p=0;p<e;++p)y[p]="a[i"+p+"]",A[p]="b[i"+p+"]";i.push("proto.transpose=function "+t+"_transpose("+a+"){"+a.map(function(l,b){return l+"=("+l+"===undefined?"+b+":"+l+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+y.join(",")+","+A.join(",")+",this.offset)}"),i.push("proto.pick=function "+t+"_pick("+a+"){var a=[],b=[],c=this.offset");for(var p=0;p<e;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){c=(c+this.stride["+p+"]*i"+p+")|0}else{a.push(this.shape["+p+"]);b.push(this.stride["+p+"])}");i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+n.map(function(l){return"shape["+l+"]"}).join(",")+","+n.map(function(l){return"stride["+l+"]"}).join(",")+",offset)}");var I=new Function("CTOR_LIST","ORDER",i.join(`
`));return I(Ye[s],Js)}function Zs(s){if(Ys(s))return"buffer";if(Hs)switch(Object.prototype.toString.call(s)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(s)?"array":"generic"}var Ye={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function Qs(s,e,t,r){if(s===void 0){var g=Ye.array[0];return g([])}else typeof s=="number"&&(s=[s]);e===void 0&&(e=[s.length]);var i=e.length;if(t===void 0){t=new Array(i);for(var n=i-1,a=1;n>=0;--n)t[n]=a,a*=e[n]}if(r===void 0){r=0;for(var n=0;n<i;++n)t[n]<0&&(r-=(e[n]-1)*t[n])}for(var c=Zs(s),o=Ye[c];o.length<=i+1;)o.push(Ks(c,o.length-1));var g=o[i+1];return g(s,e,t,r)}var er=Qs;const tr=ks(er);var sr={};function rr(s,e){for(var t=1,r=s.length,i=s[0],n=s[0],a=1;a<r;++a)if(n=i,i=s[a],e(i,n)){if(a===t){t++;continue}s[t++]=i}return s.length=t,s}function nr(s){for(var e=1,t=s.length,r=s[0],i=s[0],n=1;n<t;++n,i=r)if(i=r,r=s[n],r!==i){if(n===e){e++;continue}s[e++]=r}return s.length=e,s}function ir(s,e,t){return s.length===0?s:e?(t||s.sort(e),rr(s,e)):(t||s.sort(),nr(s))}var ar=ir,or=ar;function is(s,e,t){var r=s.length,i=e.arrayArgs.length,n=e.indexArgs.length>0,a=[],c=[],o=0,g=0,m,T;for(m=0;m<r;++m)c.push(["i",m,"=0"].join(""));for(T=0;T<i;++T)for(m=0;m<r;++m)g=o,o=s[m],m===0?c.push(["d",T,"s",m,"=t",T,"p",o].join("")):c.push(["d",T,"s",m,"=(t",T,"p",o,"-s",g,"*t",T,"p",g,")"].join(""));for(c.length>0&&a.push("var "+c.join(",")),m=r-1;m>=0;--m)o=s[m],a.push(["for(i",m,"=0;i",m,"<s",o,";++i",m,"){"].join(""));for(a.push(t),m=0;m<r;++m){for(g=o,o=s[m],T=0;T<i;++T)a.push(["p",T,"+=d",T,"s",m].join(""));n&&(m>0&&a.push(["index[",g,"]-=s",g].join("")),a.push(["++index[",o,"]"].join(""))),a.push("}")}return a.join(`
`)}function cr(s,e,t,r){for(var i=e.length,n=t.arrayArgs.length,a=t.blockSize,c=t.indexArgs.length>0,o=[],g=0;g<n;++g)o.push(["var offset",g,"=p",g].join(""));for(var g=s;g<i;++g)o.push(["for(var j"+g+"=SS[",e[g],"]|0;j",g,">0;){"].join("")),o.push(["if(j",g,"<",a,"){"].join("")),o.push(["s",e[g],"=j",g].join("")),o.push(["j",g,"=0"].join("")),o.push(["}else{s",e[g],"=",a].join("")),o.push(["j",g,"-=",a,"}"].join("")),c&&o.push(["index[",e[g],"]=j",g].join(""));for(var g=0;g<n;++g){for(var m=["offset"+g],T=s;T<i;++T)m.push(["j",T,"*t",g,"p",e[T]].join(""));o.push(["p",g,"=(",m.join("+"),")"].join(""))}o.push(is(e,t,r));for(var g=s;g<i;++g)o.push("}");return o.join(`
`)}function ur(s){for(var e=0,t=s[0].length;e<t;){for(var r=1;r<s.length;++r)if(s[r][e]!==s[0][e])return e;++e}return e}function nt(s,e,t){for(var r=s.body,i=[],n=[],a=0;a<s.args.length;++a){var c=s.args[a];if(!(c.count<=0)){var o=new RegExp(c.name,"g"),g="",m=e.arrayArgs.indexOf(a);switch(e.argTypes[a]){case"offset":var T=e.offsetArgIndex.indexOf(a),p=e.offsetArgs[T];m=p.array,g="+q"+T;case"array":g="p"+m+g;var y="l"+a,A="a"+m;if(e.arrayBlockIndices[m]===0)c.count===1?t[m]==="generic"?c.lvalue?(i.push(["var ",y,"=",A,".get(",g,")"].join("")),r=r.replace(o,y),n.push([A,".set(",g,",",y,")"].join(""))):r=r.replace(o,[A,".get(",g,")"].join("")):r=r.replace(o,[A,"[",g,"]"].join("")):t[m]==="generic"?(i.push(["var ",y,"=",A,".get(",g,")"].join("")),r=r.replace(o,y),c.lvalue&&n.push([A,".set(",g,",",y,")"].join(""))):(i.push(["var ",y,"=",A,"[",g,"]"].join("")),r=r.replace(o,y),c.lvalue&&n.push([A,"[",g,"]=",y].join("")));else{for(var I=[c.name],l=[g],b=0;b<Math.abs(e.arrayBlockIndices[m]);b++)I.push("\\s*\\[([^\\]]+)\\]"),l.push("$"+(b+1)+"*t"+m+"b"+b);if(o=new RegExp(I.join(""),"g"),g=l.join("+"),t[m]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");r=r.replace(o,[A,"[",g,"]"].join(""))}break;case"scalar":r=r.replace(o,"Y"+e.scalarArgs.indexOf(a));break;case"index":r=r.replace(o,"index");break;case"shape":r=r.replace(o,"shape");break}}}return[i.join(`
`),r,n.join(`
`)].join(`
`).trim()}function lr(s){for(var e=new Array(s.length),t=!0,r=0;r<s.length;++r){var i=s[r],n=i.match(/\d+/);n?n=n[0]:n="",i.charAt(0)===0?e[r]="u"+i.charAt(1)+n:e[r]=i.charAt(0)+n,r>0&&(t=t&&e[r]===e[r-1])}return t?e[0]:e.join("")}function hr(s,e){for(var t=e[1].length-Math.abs(s.arrayBlockIndices[0])|0,r=new Array(s.arrayArgs.length),i=new Array(s.arrayArgs.length),n=0;n<s.arrayArgs.length;++n)i[n]=e[2*n],r[n]=e[2*n+1];for(var a=[],c=[],o=[],g=[],m=[],n=0;n<s.arrayArgs.length;++n){s.arrayBlockIndices[n]<0?(o.push(0),g.push(t),a.push(t),c.push(t+s.arrayBlockIndices[n])):(o.push(s.arrayBlockIndices[n]),g.push(s.arrayBlockIndices[n]+t),a.push(0),c.push(s.arrayBlockIndices[n]));for(var T=[],p=0;p<r[n].length;p++)o[n]<=r[n][p]&&r[n][p]<g[n]&&T.push(r[n][p]-o[n]);m.push(T)}for(var y=["SS"],A=["'use strict'"],I=[],p=0;p<t;++p)I.push(["s",p,"=SS[",p,"]"].join(""));for(var n=0;n<s.arrayArgs.length;++n){y.push("a"+n),y.push("t"+n),y.push("p"+n);for(var p=0;p<t;++p)I.push(["t",n,"p",p,"=t",n,"[",o[n]+p,"]"].join(""));for(var p=0;p<Math.abs(s.arrayBlockIndices[n]);++p)I.push(["t",n,"b",p,"=t",n,"[",a[n]+p,"]"].join(""))}for(var n=0;n<s.scalarArgs.length;++n)y.push("Y"+n);if(s.shapeArgs.length>0&&I.push("shape=SS.slice(0)"),s.indexArgs.length>0){for(var l=new Array(t),n=0;n<t;++n)l[n]="0";I.push(["index=[",l.join(","),"]"].join(""))}for(var n=0;n<s.offsetArgs.length;++n){for(var b=s.offsetArgs[n],u=[],p=0;p<b.offset.length;++p)b.offset[p]!==0&&(b.offset[p]===1?u.push(["t",b.array,"p",p].join("")):u.push([b.offset[p],"*t",b.array,"p",p].join("")));u.length===0?I.push("q"+n+"=0"):I.push(["q",n,"=",u.join("+")].join(""))}var h=or([].concat(s.pre.thisVars).concat(s.body.thisVars).concat(s.post.thisVars));I=I.concat(h),I.length>0&&A.push("var "+I.join(","));for(var n=0;n<s.arrayArgs.length;++n)A.push("p"+n+"|=0");s.pre.body.length>3&&A.push(nt(s.pre,s,i));var f=nt(s.body,s,i),d=ur(m);d<t?A.push(cr(d,m[0],s,f)):A.push(is(m[0],s,f)),s.post.body.length>3&&A.push(nt(s.post,s,i)),s.debug&&console.log("-----Generated cwise routine for ",e,`:
`+A.join(`
`)+`
----------`);var E=[s.funcName||"unnamed","_cwise_loop_",r[0].join("s"),"m",d,lr(i)].join(""),x=new Function(["function ",E,"(",y.join(","),"){",A.join(`
`),"} return ",E].join(""));return x()}var fr=hr,gr=fr;function pr(s){var e=["'use strict'","var CACHED={}"],t=[],r=s.funcName+"_cwise_thunk";e.push(["return function ",r,"(",s.shimArgs.join(","),"){"].join(""));for(var i=[],n=[],a=[["array",s.arrayArgs[0],".shape.slice(",Math.max(0,s.arrayBlockIndices[0]),s.arrayBlockIndices[0]<0?","+s.arrayBlockIndices[0]+")":")"].join("")],c=[],o=[],g=0;g<s.arrayArgs.length;++g){var m=s.arrayArgs[g];t.push(["t",m,"=array",m,".dtype,","r",m,"=array",m,".order"].join("")),i.push("t"+m),i.push("r"+m),n.push("t"+m),n.push("r"+m+".join()"),a.push("array"+m+".data"),a.push("array"+m+".stride"),a.push("array"+m+".offset|0"),g>0&&(c.push("array"+s.arrayArgs[0]+".shape.length===array"+m+".shape.length+"+(Math.abs(s.arrayBlockIndices[0])-Math.abs(s.arrayBlockIndices[g]))),o.push("array"+s.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,s.arrayBlockIndices[0])+"]===array"+m+".shape[shapeIndex+"+Math.max(0,s.arrayBlockIndices[g])+"]"))}s.arrayArgs.length>1&&(e.push("if (!("+c.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+s.arrayArgs[0]+".shape.length-"+Math.abs(s.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),e.push("if (!("+o.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}"));for(var g=0;g<s.scalarArgs.length;++g)a.push("scalar"+s.scalarArgs[g]);t.push(["type=[",n.join(","),"].join()"].join("")),t.push("proc=CACHED[type]"),e.push("var "+t.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",i.join(","),"])}","return proc(",a.join(","),")}"].join("")),s.debug&&console.log(`-----Generated thunk:
`+e.join(`
`)+`
----------`);var T=new Function("compile",e.join(`
`));return T(gr.bind(void 0,s))}var dr=pr,mr=dr;function yr(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function Er(s){var e=new yr;e.pre=s.pre,e.body=s.body,e.post=s.post;var t=s.args.slice(0);e.argTypes=t;for(var r=0;r<t.length;++r){var i=t[r];if(i==="array"||typeof i=="object"&&i.blockIndices){if(e.argTypes[r]="array",e.arrayArgs.push(r),e.arrayBlockIndices.push(i.blockIndices?i.blockIndices:0),e.shimArgs.push("array"+r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array args");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array args")}else if(i==="scalar")e.scalarArgs.push(r),e.shimArgs.push("scalar"+r);else if(i==="index"){if(e.indexArgs.push(r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array index");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array index");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array index")}else if(i==="shape"){if(e.shapeArgs.push(r),r<e.pre.args.length&&e.pre.args[r].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array shape");if(r<e.post.args.length&&e.post.args[r].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof i=="object"&&i.offset)e.argTypes[r]="offset",e.offsetArgs.push({array:i.array,offset:i.offset}),e.offsetArgIndex.push(r);else throw new Error("cwise: Unknown argument type "+t[r])}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>t.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>t.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>t.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!s.printCode||!!s.debug,e.funcName=s.funcName||"cwise",e.blockSize=s.blockSize||64,mr(e)}var Tr=Er;(function(s){var e=Tr,t={body:"",args:[],thisVars:[],localVars:[]};function r(p){if(!p)return t;for(var y=0;y<p.args.length;++y){var A=p.args[y];y===0?p.args[y]={name:A,lvalue:!0,rvalue:!!p.rvalue,count:p.count||1}:p.args[y]={name:A,lvalue:!1,rvalue:!0,count:1}}return p.thisVars||(p.thisVars=[]),p.localVars||(p.localVars=[]),p}function i(p){return e({args:p.args,pre:r(p.pre),body:r(p.body),post:r(p.proc),funcName:p.funcName})}function n(p){for(var y=[],A=0;A<p.args.length;++A)y.push("a"+A);var I=new Function("P",["return function ",p.funcName,"_ndarrayops(",y.join(","),") {P(",y.join(","),");return a0}"].join(""));return I(i(p))}var a={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var p in a){var y=a[p];s[p]=n({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+y+"c"},funcName:p}),s[p+"eq"]=n({args:["array","array"],body:{args:["a","b"],body:"a"+y+"=b"},rvalue:!0,funcName:p+"eq"}),s[p+"s"]=n({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+y+"s"},funcName:p+"s"}),s[p+"seq"]=n({args:["array","scalar"],body:{args:["a","s"],body:"a"+y+"=s"},rvalue:!0,funcName:p+"seq"})}})();var c={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var p in c){var y=c[p];s[p]=n({args:["array","array"],body:{args:["a","b"],body:"a="+y+"b"},funcName:p}),s[p+"eq"]=n({args:["array"],body:{args:["a"],body:"a="+y+"a"},rvalue:!0,count:2,funcName:p+"eq"})}})();var o={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var p in o){var y=o[p];s[p]=n({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+y+"c"},funcName:p}),s[p+"s"]=n({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+y+"s"},funcName:p+"s"}),s[p+"eq"]=n({args:["array","array"],body:{args:["a","b"],body:"a=a"+y+"b"},rvalue:!0,count:2,funcName:p+"eq"}),s[p+"seq"]=n({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+y+"s"},rvalue:!0,count:2,funcName:p+"seq"})}})();var g=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var p=0;p<g.length;++p){var y=g[p];s[y]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:y}),s[y+"eq"]=n({args:["array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:y+"eq"})}})();var m=["max","min","atan2","pow"];(function(){for(var p=0;p<m.length;++p){var y=m[p];s[y]=n({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:y}),s[y+"s"]=n({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:y+"s"}),s[y+"eq"]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:y+"eq"}),s[y+"seq"]=n({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:y+"seq"})}})();var T=["atan2","pow"];(function(){for(var p=0;p<T.length;++p){var y=T[p];s[y+"op"]=n({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:y+"op"}),s[y+"ops"]=n({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:y+"ops"}),s[y+"opeq"]=n({args:["array","array"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:y+"opeq"}),s[y+"opseq"]=n({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+y,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:y+"opseq"})}})(),s.any=e({args:["array"],pre:t,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),s.all=e({args:["array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),s.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),s.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),s.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),s.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),s.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),s.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),s.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.random=n({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),s.assign=n({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),s.assigns=n({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),s.equals=e({args:["array","array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})(sr);function br(s,e){if(!(s instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const t=new Blob([s],{type:e}),r=URL.createObjectURL(t);return new Promise((i,n)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=function(){URL.revokeObjectURL(r);const c=document.createElement("canvas");c.width=a.width,c.height=a.height;const o=c.getContext("2d");o.drawImage(a,0,0);const g=o.getImageData(0,0,a.width,a.height);i(tr(new Uint8Array(g.data),[a.width,a.height,4],[4,4*a.width,1],0))},a.onerror=c=>{URL.revokeObjectURL(r),n(c)},a.src=r})}async function vr(s,e){return br(s,e)}function me(){return me=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},me.apply(this,arguments)}function as(s,e){return Object.defineProperty(e,"name",{value:s}),e}function _t(s){return s.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function Ar(s,e){return`${_t(s)}  ${_t(e)} (${function(t,r,i=2){return(t>r?"":"+")+(Math.abs(t-r)/t*100).toFixed(i)+"%"}(s,e)})`}function wr(s){const e=[];for(const t of s.listAttributes())e.push(t);for(const t of s.listTargets())for(const r of t.listAttributes())e.push(r);return Array.from(new Set(e))}function ce(s,e=s){const t=e<=65534?new Uint16Array(s):new Uint32Array(s);for(let r=0;r<t.length;r++)t[r]=r;return t}function Rr(s){const e=new Set;let t,r=s;for(;t=r.getParentNode();){if(e.has(t))throw new Error("Circular dependency in scene graph.");e.add(t),r=t}return r.listParents().filter(i=>i instanceof Ze)}function Ir(s){const e=Rr(s),t=s.getParentNode();if(!t)return s;s.setMatrix(s.getWorldMatrix()),t.removeChild(s);for(const r of e)r.addChild(s);return s}var ye=typeof Float32Array<"u"?Float32Array:Array;function xr(s,e,t){var r=e[0],i=e[1],n=e[2],a=e[3],c=e[4],o=e[5],g=e[6],m=e[7],T=e[8],p=e[9],y=e[10],A=e[11],I=e[12],l=e[13],b=e[14],u=e[15],h=t[0],f=t[1],d=t[2],E=t[3];return s[0]=h*r+f*c+d*T+E*I,s[1]=h*i+f*o+d*p+E*l,s[2]=h*n+f*g+d*y+E*b,s[3]=h*a+f*m+d*A+E*u,s[4]=(h=t[4])*r+(f=t[5])*c+(d=t[6])*T+(E=t[7])*I,s[5]=h*i+f*o+d*p+E*l,s[6]=h*n+f*g+d*y+E*b,s[7]=h*a+f*m+d*A+E*u,s[8]=(h=t[8])*r+(f=t[9])*c+(d=t[10])*T+(E=t[11])*I,s[9]=h*i+f*o+d*p+E*l,s[10]=h*n+f*g+d*y+E*b,s[11]=h*a+f*m+d*A+E*u,s[12]=(h=t[12])*r+(f=t[13])*c+(d=t[14])*T+(E=t[15])*I,s[13]=h*i+f*o+d*p+E*l,s[14]=h*n+f*g+d*y+E*b,s[15]=h*a+f*m+d*A+E*u,s}function et(){var s=new ye(3);return ye!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function os(s,e){var t=e[0],r=e[1],i=e[2],n=t*t+r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s}function Mr(s,e,t){var r=e[0],i=e[1],n=e[2],a=t[3]*r+t[7]*i+t[11]*n+t[15];return s[0]=(t[0]*r+t[4]*i+t[8]*n+t[12])/(a=a||1),s[1]=(t[1]*r+t[5]*i+t[9]*n+t[13])/a,s[2]=(t[2]*r+t[6]*i+t[10]*n+t[14])/a,s}function _r(s,e,t){var r=e[0],i=e[1],n=e[2];return s[0]=r*t[0]+i*t[3]+n*t[6],s[1]=r*t[1]+i*t[4]+n*t[7],s[2]=r*t[2]+i*t[5]+n*t[8],s}Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});var Nr=function(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s};function Tt(){var s=new ye(4);return ye!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}et();var cs=function(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s},Sr=function(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s[3]=e[3]*t[3],s},us=function(s){return Math.hypot(s[0],s[1],s[2],s[3])};Tt();M.ACCESSOR,M.MESH,M.TEXTURE,M.MATERIAL,M.SKIN;const Cr=/color|emissive|diffuse/i;function Or(s){return s.getGraph().listParentEdges(s).some(e=>e.getAttributes().isColor||Cr.test(e.getName()))?"srgb":null}function Vr(s){const e=s.getGraph(),t=new Set,r=new Set;return function i(n){const a=new Set;for(const c of e.listChildEdges(n))c.getChild()instanceof _e&&a.add(c.getName()+"Info");for(const c of e.listChildEdges(n)){const o=c.getChild();t.has(o)||(t.add(o),o instanceof H&&a.has(c.getName())?r.add(o):o instanceof Ce&&i(o))}}(s),Array.from(r)}function Pr(s){const e=Qe.fromGraph(s.getGraph()).getRoot(),t=s.getGraph().listParentEdges(s).filter(r=>r.getParent()!==e).map(r=>r.getName());return Array.from(new Set(t))}const ue="prune",gt=3/255,Nt={propertyTypes:[M.NODE,M.SKIN,M.MESH,M.CAMERA,M.PRIMITIVE,M.PRIMITIVE_TARGET,M.ANIMATION,M.MATERIAL,M.TEXTURE,M.ACCESSOR,M.BUFFER],keepLeaves:!1,keepAttributes:!0,keepSolidTextures:!0};function Fr(s=Nt){const e=me({},Nt,s),t=new Set(e.propertyTypes);return as(ue,async r=>{const i=r.getLogger(),n=r.getRoot(),a=r.getGraph(),c=new Lr;if(t.has(M.MESH))for(const o of n.listMeshes())o.listPrimitives().length>0||c.dispose(o);if(t.has(M.NODE)){if(!e.keepLeaves)for(const o of n.listScenes())ls(a,o,c);for(const o of n.listNodes())W(o,c)}if(t.has(M.SKIN))for(const o of n.listSkins())W(o,c);if(t.has(M.MESH))for(const o of n.listMeshes())W(o,c);if(t.has(M.CAMERA))for(const o of n.listCameras())W(o,c);if(t.has(M.PRIMITIVE)&&St(a,M.PRIMITIVE,c),t.has(M.PRIMITIVE_TARGET)&&St(a,M.PRIMITIVE_TARGET,c),!e.keepAttributes&&t.has(M.ACCESSOR)){const o=new Map;for(const g of n.listMeshes())for(const m of g.listPrimitives()){const T=m.getMaterial(),p=jr(m,hs(r,T));Ct(m,p),m.listTargets().forEach(y=>Ct(y,p)),T&&(o.has(T)?o.get(T).add(m):o.set(T,new Set([m])))}for(const[g,m]of o)Br(g,Array.from(m))}if(t.has(M.ANIMATION))for(const o of n.listAnimations()){for(const g of o.listChannels())g.getTargetNode()||c.dispose(g);if(o.listChannels().length)o.listSamplers().forEach(g=>W(g,c));else{const g=o.listSamplers();W(o,c),g.forEach(m=>W(m,c))}}if(t.has(M.MATERIAL)&&n.listMaterials().forEach(o=>W(o,c)),t.has(M.TEXTURE)&&(n.listTextures().forEach(o=>W(o,c)),e.keepSolidTextures||await async function(o,g){const m=o.getRoot(),T=o.getGraph(),p=o.getLogger(),y=m.listTextures().map(async A=>{var I;const l=await async function(f){const d=await async function(_){try{return await vr(_.getImage(),_.getMimeType())}catch{return null}}(f);if(!d)return null;const E=[1/0,1/0,1/0,1/0],x=[-1/0,-1/0,-1/0,-1/0],N=[0,0,0,0],[v,w]=d.shape;for(let _=0;_<v;_++){for(let V=0;V<w;V++)for(let P=0;P<4;P++)E[P]=Math.min(E[P],d.get(_,V,P)),x[P]=Math.max(x[P],d.get(_,V,P));if(us(cs(N,x,E))/255>gt)return null}return function(_,V,P){return _[0]=V[0]*P,_[1]=V[1]*P,_[2]=V[2]*P,_[3]=V[3]*P,_}(N,((R=N)[0]=(O=x)[0]+(S=E)[0],R[1]=O[1]+S[1],R[2]=O[2]+S[2],R[3]=O[3]+S[3],R),.00196078431372549);var R,O,S}(A);if(!l)return;Or(A)==="srgb"&&ve.convertSRGBToLinear(l,l);const b=A.getName()||A.getURI(),u=(I=A.getSize())==null?void 0:I.join("x"),h=Pr(A);for(const f of T.listParentEdges(A)){const d=f.getParent();d!==m&&Ur(d,l,f.getName(),p)&&f.dispose()}A.listParents().length===1&&(g.dispose(A),p.debug(`${ue}: Removed solid-color texture "${b}" (${u}px ${h.join(", ")})`))});await Promise.all(y)}(r,c)),t.has(M.ACCESSOR)&&n.listAccessors().forEach(o=>W(o,c)),t.has(M.BUFFER)&&n.listBuffers().forEach(o=>W(o,c)),c.empty())i.info(`${ue}: No unused properties found.`);else{const o=c.entries().map(([g,m])=>`${g} (${m})`).join(", ");i.info(`${ue}: Removed types... ${o}`)}i.debug(`${ue}: Complete.`)})}class Lr{constructor(){this.disposed={}}empty(){for(const e in this.disposed)return!1;return!0}entries(){return Object.entries(this.disposed)}dispose(e){this.disposed[e.propertyType]=this.disposed[e.propertyType]||0,this.disposed[e.propertyType]++,e.dispose()}}function W(s,e){s.listParents().filter(t=>!(t instanceof ss||t instanceof Ke)).length||e.dispose(s)}function St(s,e,t){for(const r of s.listEdges()){const i=r.getParent();i.propertyType===e&&W(i,t)}}function ls(s,e,t){if(e.listChildren().forEach(i=>ls(s,i,t)),e instanceof Ze)return;const r=s.listParentEdges(e).some(i=>{const n=i.getParent().propertyType;return n!==M.ROOT&&n!==M.SCENE&&n!==M.NODE});s.listChildren(e).length===0&&!r&&t.dispose(e)}function Ct(s,e){for(const t of e)s.setAttribute(t,null)}function jr(s,e){const t=[];for(const r of s.listSemantics())r!=="TANGENT"||e.has(r)?(r.startsWith("TEXCOORD_")&&!e.has(r)||r.startsWith("COLOR_")&&r!=="COLOR_0")&&t.push(r):t.push(r);return t}function hs(s,e,t=new Set){if(!e)return t;const r=s.getGraph().listChildEdges(e),i=new Set;for(const n of r)n.getChild()instanceof _e&&i.add(n.getName());for(const n of r){const a=n.getName(),c=n.getChild();c instanceof H&&i.has(a.replace(/Info$/,""))&&t.add(`TEXCOORD_${c.getTexCoord()}`),c instanceof _e&&a.match(/normalTexture/i)&&t.add("TANGENT"),c instanceof Ce&&hs(s,c,t)}return t}function Br(s,e){const t=Vr(s),r=new Set(t.map(o=>o.getTexCoord())),i=Array.from(r).sort(),n=new Map(i.map((o,g)=>[o,g])),a=new Map(i.map((o,g)=>[`TEXCOORD_${o}`,`TEXCOORD_${g}`]));for(const o of t){const g=o.getTexCoord();o.setTexCoord(n.get(g))}for(const o of e){const g=o.listSemantics().filter(m=>m.startsWith("TEXCOORD_")).sort();c(o,g),o.listTargets().forEach(m=>c(m,g))}function c(o,g){for(const m of g){const T=o.getAttribute(m);if(!T)continue;const p=a.get(m);p!==m&&(o.setAttribute(p,T),o.setAttribute(m,null))}}}function Ur(s,e,t,r){if(s instanceof pe)switch(t){case"baseColorTexture":return s.setBaseColorFactor(Sr(e,e,s.getBaseColorFactor())),!0;case"emissiveTexture":return s.setEmissiveFactor(Nr([0,0,0],e.slice(0,3),s.getEmissiveFactor())),!0;case"occlusionTexture":return Math.abs(e[0]-1)<=gt;case"metallicRoughnessTexture":return s.setRoughnessFactor(e[1]*s.getRoughnessFactor()),s.setMetallicFactor(e[2]*s.getMetallicFactor()),!0;case"normalTexture":return us(cs(Tt(),e,[.5,.5,1,1]))<=gt}return r.warn(`${ue}: Detected single-color ${t} texture. Pruning ${t} not yet supported.`),!1}const He="weld",he={DEFAULT:1e-4,TEXCOORD:1e-4,COLOR:.01,NORMAL:.05,JOINTS:0,WEIGHTS:.01},pt={tolerance:he.DEFAULT,toleranceNormal:he.NORMAL,overwrite:!0,exhaustive:!1};function Dr(s,e=pt,t=pt){let r,i,n;if(s instanceof de){const a=s.getGraph();r=Qe.fromGraph(a),i=s,n=Pt(e)}else r=s,i=e,n=Pt(t);i.getIndices()&&!n.overwrite||i.getMode()!==de.Mode.POINTS&&(n.tolerance===0?function(a,c){if(c.getIndices())return;const o=c.listAttributes()[0],g=o.getCount(),m=o.getBuffer(),T=a.createAccessor().setBuffer(m).setType(C.Type.SCALAR).setArray(ce(g));c.setIndices(T)}(r,i):function(a,c,o){const g=a.getLogger(),m=c.getAttribute("POSITION"),T=c.getIndices()||a.createAccessor().setArray(ce(m.getCount())),p=new Uint32Array(new Set(T.getArray())).sort(),y={};for(const v of c.listSemantics()){const w=c.getAttribute(v);y[v]=kr(v,w,o)}var A;g.debug(`${He}: Tolerance thresholds: ${A=y,Object.entries(A).map(([v,w])=>`${v}=${w}`).join(", ")}`);const I=[0,0,0],l=[0,0,0],b={},u=y.POSITION;for(let v=0;v<p.length;v++){m.getElement(p[v],I);const w=dt(I,u);b[w]=b[w]||[],b[w].push(p[v])}const h=ce(p[p.length-1]+1),f=new Array(p.length).fill(-1),d=m.getCount();let E=0;for(let v=0;v<p.length;v++){const w=p[v];m.getElement(w,I);const R=o.exhaustive?Gr(I,u):[dt(I,u)];e:for(const O of R)if(b[O])t:for(const S of b[O]){const _=h[S];if(w<=_)continue t;m.getElement(_,l);const V=c.listSemantics().every(j=>Vt(c.getAttribute(j),w,_,y[j])),P=c.listTargets().every(j=>j.listSemantics().every(D=>Vt(j.getAttribute(D),w,_,y[D])));if(V&&P){h[w]=_;break e}}f[w]=h[w]===w?E++:f[h[w]]}g.debug(`${He}: ${Ar(d,E)} vertices.`);const x=T.getCount(),N=ce(x,p.length);for(let v=0;v<x;v++)N[v]=f[T.getScalar(v)];c.setIndices(T.clone().setArray(N)),T.listParents().length===1&&T.dispose();for(const v of c.listAttributes())Ot(c,v,f,E);for(const v of c.listTargets())for(const w of v.listAttributes())Ot(v,w,f,E);(function(v){const w=v.getIndices();if(!w)return;const R=[];let O=-1/0;for(let _=0,V=w.getCount();_<V;_+=3){const P=w.getScalar(_),j=w.getScalar(_+1),D=w.getScalar(_+2);P!==j&&P!==D&&j!==D&&(R.push(P,j,D),O=Math.max(O,P,j,D))}const S=ce(R.length,O);S.set(R),w.setArray(S)})(c)}(r,i,n))}function Ot(s,e,t,r){const i=(c=e.getArray(),o=r*e.getElementSize(),new c.constructor(o)),n=e.clone().setArray(i),a=new Uint8Array(r);var c,o;for(let g=0,m=[];g<t.length;g++)a[t[g]]||(n.setElement(t[g],e.getElement(g,m)),a[t[g]]=1);s.swap(e,n),e.listParents().length===1&&e.dispose()}const xe=[],Me=[];function kr(s,e,t){if(s==="NORMAL"||s==="TANGENT")return t.toleranceNormal;if(s.startsWith("COLOR_"))return he.COLOR;if(s.startsWith("TEXCOORD_"))return he.TEXCOORD;if(s.startsWith("JOINTS_"))return he.JOINTS;if(s.startsWith("WEIGHTS_"))return he.WEIGHTS;xe.length=Me.length=0,e.getMinNormalized(xe),e.getMaxNormalized(Me);const r=Me.map((n,a)=>n-xe[a]),i=Math.max(...r);return t.tolerance*i}function Vt(s,e,t,r,i){s.getElement(e,xe),s.getElement(t,Me);for(let n=0,a=s.getElementSize();n<a;n++)if(Math.abs(xe[n]-Me[n])>r)return!1;return!0}const it=[0,-1,1];function Gr(s,e){const t=[],r=[0,0,0];for(const i of it)for(const n of it)for(const a of it)r[0]=s[0]+i*e,r[1]=s[1]+n*e,r[2]=s[2]+a*e,t.push(dt(r,e));return t}function dt(s,e){return Math.round(s[0]/e)+":"+Math.round(s[1]/e)+":"+Math.round(s[2]/e)}function Pt(s){const e=me({},pt,s);if(e.tolerance<0||e.tolerance>.1)throw new Error(`${He}: Requires 0  tolerance  0.1`);if(e.toleranceNormal<0||e.toleranceNormal>Math.PI/2)throw new Error(`${He}: Requires 0  toleranceNormal  ${(Math.PI/2).toFixed(2)}`);return e.tolerance>0&&(e.tolerance=Math.max(e.tolerance,Number.EPSILON),e.toleranceNormal=Math.max(e.toleranceNormal,Number.EPSILON)),e}function zr(s,e,t=new Set){var r;const i=s.getAttribute("POSITION"),n=((r=s.getIndices())==null?void 0:r.getArray())||ce(i.getCount());i&&Ft(e,i,n,new Set(t));const a=s.getAttribute("NORMAL");a&&Lt(e,a,n,new Set(t));const c=s.getAttribute("TANGENT");c&&jt(e,c,n,new Set(t));for(const v of s.listTargets()){const w=v.getAttribute("POSITION");w&&Ft(e,w,n,new Set(t));const R=v.getAttribute("NORMAL");R&&Lt(e,R,n,new Set(t));const O=v.getAttribute("TANGENT");O&&jt(e,O,n,new Set(t))}var o,g,m,T,p,y,A,I,l,b,u,h,f,d,E,x,N;((g=(o=e)[0])*(A=o[5])-(m=o[1])*(y=o[4]))*((h=o[10])*(N=o[15])-(f=o[11])*(x=o[14]))-(g*(I=o[6])-(T=o[2])*y)*((u=o[9])*N-f*(E=o[13]))+(g*(l=o[7])-(p=o[3])*y)*(u*x-h*E)+(m*I-T*A)*((b=o[8])*N-f*(d=o[12]))-(m*l-p*A)*(b*x-h*d)+(T*l-p*I)*(b*E-u*d)<0&&function(v){if(v.getMode()!==de.Mode.TRIANGLES)return;v.getIndices()||Dr(v,{tolerance:0});const w=v.getIndices();for(let R=0,O=w.getCount();R<O;R+=3){const S=w.getScalar(R),_=w.getScalar(R+2);w.setScalar(R,_),w.setScalar(R+2,S)}}(s);for(let v=0;v<n.length;v++)t.add(n[v])}function Ft(s,e,t,r){const i=new Float32Array(3*e.getCount()),n=e.getElementSize();for(let c=0,o=[],g=e.getCount();c<g;c++)i.set(e.getElement(c,o),c*n);const a=et();for(let c=0;c<t.length;c++){const o=t[c];r.has(o)||(e.getElement(o,a),Mr(a,a,s),i.set(a,3*o),r.add(o))}e.setArray(i).setNormalized(!1)}function Lt(s,e,t,r){const i=(n=new ye(9),ye!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n);var n;(function(c,o){c[0]=o[0],c[1]=o[1],c[2]=o[2],c[3]=o[4],c[4]=o[5],c[5]=o[6],c[6]=o[8],c[7]=o[9],c[8]=o[10]})(i,s),function(c,o){var g=o[0],m=o[1],T=o[2],p=o[3],y=o[4],A=o[5],I=o[6],l=o[7],b=o[8],u=b*y-A*l,h=-b*p+A*I,f=l*p-y*I,d=g*u+m*h+T*f;d&&(c[0]=u*(d=1/d),c[1]=(-b*m+T*l)*d,c[2]=(A*m-T*y)*d,c[3]=h*d,c[4]=(b*g-T*I)*d,c[5]=(-A*g+T*p)*d,c[6]=f*d,c[7]=(-l*g+m*I)*d,c[8]=(y*g-m*p)*d)}(i,i),function(c,o){if(c===o){var g=o[1],m=o[2],T=o[5];c[1]=o[3],c[2]=o[6],c[3]=g,c[5]=o[7],c[6]=m,c[7]=T}else c[0]=o[0],c[1]=o[3],c[2]=o[6],c[3]=o[1],c[4]=o[4],c[5]=o[7],c[6]=o[2],c[7]=o[5],c[8]=o[8]}(i,i);const a=et();for(let c=0;c<t.length;c++){const o=t[c];r.has(o)||(e.getElement(o,a),_r(a,a,i),os(a,a),e.setElement(o,a),r.add(o))}}function jt(s,e,t,r){const i=et(),n=Tt();for(let a=0;a<t.length;a++){const c=t[a];if(r.has(c))continue;e.getElement(c,n);const[o,g,m]=n;i[0]=s[0]*o+s[4]*g+s[8]*m,i[1]=s[1]*o+s[5]*g+s[9]*m,i[2]=s[2]*o+s[6]*g+s[10]*m,os(i,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],e.setElement(c,n),r.add(c)}}function $r(s,e,t=!1,r){for(const n of s.listPrimitives())if(n.listParents().some(a=>a.propertyType===M.MESH&&a!==s)){const a=n.clone();s.swap(n,a);for(const c of a.listTargets()){const o=c.clone();a.swap(c,o)}}if(!t){const n=new Set([...s.listPrimitives(),...s.listPrimitives().flatMap(c=>c.listTargets())]),a=new Map;for(const c of s.listPrimitives())for(const o of wr(c))o.listParents().some(g=>(g instanceof de||g instanceof es)&&!n.has(g))&&!a.has(o)&&a.set(o,o.clone());for(const c of n)for(const[o,g]of a)c.swap(o,g)}const i=new Map;for(const n of s.listPrimitives()){const a=n.getAttribute("POSITION");let c;r?c=r:i.has(a)?c=i.get(a):i.set(a,c=new Set),zr(n,e,c)}}const Bt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function gn(s){const e=s.getMesh(),t=s.getMatrix();e&&!B.eq(t,Bt)&&$r(e,t);for(const r of s.listChildren()){const i=r.getMatrix();xr(i,i,t),r.setMatrix(i)}return s.setMatrix(Bt)}const at="flatten",Ut={};function pn(s=Ut){return me({},Ut,s),as(at,async e=>{const t=e.getRoot(),r=e.getLogger(),i=new Set;for(const o of t.listSkins())for(const g of o.listJoints())i.add(g);const n=new Set;for(const o of t.listAnimations())for(const g of o.listChannels()){const m=g.getTargetNode();m&&n.add(m)}const a=new Set,c=new Set;for(const o of t.listScenes())o.traverse(g=>{const m=g.getParentNode();m&&((i.has(m)||a.has(m))&&a.add(g),(n.has(m)||c.has(m))&&c.add(g))});for(const o of t.listScenes())o.traverse(g=>{n.has(g)||a.has(g)||c.has(g)||Ir(g)});n.size&&r.debug(`${at}: Flattening node hierarchies with TRS animation not yet supported.`),await e.transform(Fr({propertyTypes:[M.NODE],keepLeaves:!1})),r.debug(`${at}: Complete.`)})}Ke.TargetPath;const qr={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0};me({level:"high"},qr);var Dt;function Ee(s,e,t){for(let r=0,i=t.length;r<i;r++)t[r]=s[e*i+r];return t}function kt(s,e,t){for(let r=0,i=t.length;r<i;r++)s[e*i+r]=t[r]}function De(s,e,t=0){if(s.length!==e.length)return!1;for(let r=0;r<s.length;r++)if(Math.abs(s[r]-e[r])>t)return!1;return!0}function Wr(s,e,t){return s*(1-t)+e*t}function Yr(s,e,t,r){for(let i=0;i<e.length;i++)s[i]=Wr(e[i],t[i],r);return s}function Hr(s,e,t,r){let i,n,a,c,o,g=e[0],m=e[1],T=e[2],p=e[3],y=t[0],A=t[1],I=t[2],l=t[3];return n=g*y+m*A+T*I+p*l,n<0&&(n=-n,y=-y,A=-A,I=-I,l=-l),1-n>1e-6?(i=Math.acos(n),a=Math.sin(i),c=Math.sin((1-r)*i)/a,o=Math.sin(r*i)/a):(c=1-r,o=r),s[0]=c*g+o*y,s[1]=c*m+o*A,s[2]=c*T+o*I,s[3]=c*p+o*l,s}function Gt(s,e){const t=function(r,i){return r[0]*i[0]+r[1]*i[1]+r[2]*i[2]+r[3]*i[3]}(s,e);return Math.acos(2*t*t-1)}(function(s){s[s.STEP=0]="STEP",s[s.LERP=1]="LERP",s[s.SLERP=2]="SLERP"})(Dt||(Dt={}));Promise.resolve();var Xe;(function(s){s.LANCZOS3="lanczos3",s.LANCZOS2="lanczos2"})(Xe||(Xe={}));Xe.LANCZOS3;Xe.LANCZOS3;const Y="EXT_mesh_manifold",zt="MERGE";class bt extends Ce{static EXTENSION_NAME=Y;init(){bt.EXTENSION_NAME=Y,this.propertyType="ManifoldPrimitive",this.parentTypes=[M.MESH]}getDefaults(){return Object.assign(super.getDefaults(),{manifoldPrimitive:null,mergeIndices:null,mergeValues:null})}getMergeIndices(){return this.getRef("mergeIndices")}getMergeValues(){return this.getRef("mergeValues")}setMerge(e,t){if(e.getCount()!==t.getCount())throw new Error("merge vectors must be the same length.");return this.setRef("mergeIndices",e),this.setRef("mergeValues",t)}getRunIndex(){return this.get("runIndex")}setRunIndex(e){return this.set("runIndex",e)}setIndices(e){return this.setRef("indices",e)}getIndices(){return this.getRef("indices")}}class fs extends rs{extensionName=Y;prewriteTypes=[M.ACCESSOR];static EXTENSION_NAME=Y;createManifoldPrimitive(){return new bt(this.document.getGraph())}read(e){const{json:t}=e.jsonDoc;return(t.meshes||[]).forEach((i,n)=>{if(!i.extensions||!i.extensions[Y])return;const a=e.meshes[n],c=this.createManifoldPrimitive();a.setExtension(Y,c);const o=i.extensions[Y];if(o.manifoldPrimitive){let g=0;const m=[];m.push(g);for(const T of a.listPrimitives()){const p=T.getIndices();if(!p){console.log("Skipping non-indexed primitive ",T.getName());continue}g+=p.getCount(),m.push(g)}c.setRunIndex(m),c.setIndices(e.accessors[o.manifoldPrimitive.indices])}o.mergeIndices!=null&&o.mergeValues!=null&&c.setMerge(e.accessors[o.mergeIndices],e.accessors[o.mergeValues])}),this}prewrite(e){return this.document.getRoot().listMeshes().forEach(t=>{const r=t.getExtension(Y);if(!r)return;const i=r.getIndices();e.addAccessorToUsageGroup(i,te.BufferViewUsage.ELEMENT_ARRAY_BUFFER);const n=r.getMergeIndices(),a=r.getMergeValues();!n||!a||(e.addAccessorToUsageGroup(n,zt),e.addAccessorToUsageGroup(a,zt))}),this}write(e){const{json:t}=e.jsonDoc;return this.document.getRoot().listMeshes().forEach(r=>{const i=r.getExtension(Y);if(!i)return;const n=e.meshIndexMap.get(r),a=t.meshes[n],c=i.getRunIndex(),o=c.length-1;if(o!==a.primitives.length)throw new Error("The number of primitives must be exactly one less than the length of runIndex.");const g=e.accessorIndexMap.get(i.getMergeIndices()),m=e.accessorIndexMap.get(i.getMergeValues()),T=t.accessors[g],p=t.accessors[m],y=a.primitives[0],A={indices:e.accessorIndexMap.get(i.getIndices()),mode:y.mode,attributes:{POSITION:y.attributes.POSITION}},I=t.accessors[A.indices];if(I){T&&p&&(I.sparse={count:T.count,indices:{bufferView:T.bufferView,byteOffset:T.byteOffset,componentType:T.componentType},values:{bufferView:p.bufferView,byteOffset:p.byteOffset}});for(let l=0;l<o;++l){const b=t.accessors[a.primitives[l].indices];b.bufferView=I.bufferView,b.byteOffset=I.byteOffset+4*c[l],b.count=c[l+1]-c[l]}a.extensions=a.extensions||{},a.extensions[Y]={manifoldPrimitive:A,mergeIndices:g,mergeValues:m}}}),this}}const X={POSITION:{type:C.Type.VEC3,components:3},NORMAL:{type:C.Type.VEC3,components:3},TANGENT:{type:C.Type.VEC4,components:4},TEXCOORD_0:{type:C.Type.VEC2,components:2},TEXCOORD_1:{type:C.Type.VEC2,components:2},COLOR_0:{type:C.Type.VEC3,components:3},JOINTS_0:{type:C.Type.VEC4,components:4},WEIGHTS_0:{type:C.Type.VEC4,components:4},SKIP_1:{type:null,components:1},SKIP_2:{type:null,components:2},SKIP_3:{type:null,components:3},SKIP_4:{type:null,components:4}};function dn(s){return s.registerExtensions([fs])}function mn(s,e=[]){const t=s.listPrimitives();if(t.length===0)return null;if(e.length===0){const u=new Set;for(const f of t){const d=f.listSemantics();for(const E of d)u.add(E)}let h;for(h in X)u.has(h)&&(e.push(h),u.delete(h));for(const f of u.keys())e.push(f)}if(e.length<1||e[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');let r=0;const i=e.map((r=0,u=>{const h=r;return r+=X[u].components,h})),n=s.getExtension("EXT_mesh_manifold");let a=[],c=[];const o=[0],g=[],m=[],T=[];if(n!=null){const u=t[0].getAttribute("POSITION").getCount(),h=e.map(x=>X[x].type==null);a=new Array(r*u);for(const x of t){const N=x.getIndices();if(!N){console.log("Skipping non-indexed primitive ",x.getName());continue}const v=x.listSemantics();e.forEach((w,R)=>{if(!h[R]){for(const O of v)if(O===w){h[R]=!0;const S=x.getAttribute(O);gs(a,S,r,i[R])}}}),c=[...c,...N.getArray()],o.push(c.length),T.push({material:x.getMaterial(),attributes:v.filter(w=>e.some(R=>R==w))})}const f=n.getMergeIndices()?.getArray()??[],d=n.getMergeValues()?.getArray()??[],E=new Map;for(const[x,N]of f.entries())E.set(c[N],d[x]);for(const[x,N]of E.entries())g.push(x),m.push(N)}else for(const u of t){const h=u.getIndices();if(!h){console.log("Skipping non-indexed primitive ",u.getName());continue}const f=a.length/r;a=[...a,...Xr(u,r,e)],c=[...c,...h.getArray().map(E=>E+f)],o.push(c.length);const d=u.listSemantics();T.push({material:u.getMaterial(),attributes:d.filter(E=>e.some(x=>x==E))})}const p=new Float32Array(a),y=new Uint32Array(c),A=new Uint32Array(o),I=new Uint32Array(g),l=new Uint32Array(m);return{mesh:{numProp:r,triVerts:y,vertProperties:p,runIndex:A,mergeFromVert:I,mergeToVert:l},runProperties:T}}function yn(s,e,t){s.getRoot().listBuffers().length===0&&s.createBuffer();const r=s.getRoot().listBuffers()[0],i=s.createExtension(fs),n=s.createMesh(),a=[],c=[],o=new Map,g=e.runIndex.length-1;let m=-1;for(let h=0;h<g;++h){const f=e.runOriginalID[h];if(f==m)continue;m=f,a.push(e.runIndex[h]);const d=s.createAccessor("primitive indices of ID "+f).setBuffer(r).setType(C.Type.SCALAR).setArray(new Uint32Array(1)),E=s.createPrimitive().setIndices(d),x=t.get(f);if(x){const{material:N,attributes:v}=x;if(v.length<1||v[0]!=="POSITION")throw new Error('First attribute must be "POSITION".');E.setMaterial(N),o.set(E,v),x.attributes.forEach((w,R)=>{if(R>=c.length)c.push(w);else{const O=X[w].components,S=X[c[R]].components;if(O!=S)throw new Error("Attribute sizes do not correspond: "+w+" and "+c[R]);X[c[R]].type==null&&(c[R]=w)}})}else o.set(E,["POSITION"]);n.addPrimitive(E)}a.push(e.runIndex[g]);const T=e.numVert,p=e.numProp;let y=0;c.forEach((h,f)=>{const d=X[h];if(d==null)throw new Error(h+" is not a recognized attribute.");if(d.type==null){++y;return}const E=d.components;if(y+E>p)throw new Error("Too many attribute channels.");const x=new Float32Array(E*T);for(let v=0;v<T;++v)for(let w=0;w<E;++w){let R=e.vertProperties[p*v+y+w];h=="COLOR_0"&&(R=Math.max(0,Math.min(1,R))),x[E*v+w]=R}const N=s.createAccessor(h).setBuffer(r).setType(d.type).setArray(x);for(const v of n.listPrimitives()){const w=o.get(v);w.length>f&&X[w[f]].type!=null&&v.setAttribute(h,N)}y+=E});const A=i.createManifoldPrimitive();n.setExtension("EXT_mesh_manifold",A);const I=s.createAccessor("manifold indices").setBuffer(r).setType(C.Type.SCALAR).setArray(e.triVerts);A.setIndices(I),A.setRunIndex(a);const l=[...Array(e.numVert).keys()],b=[],u=[];if(e.mergeFromVert&&e.mergeToVert){for(const[h,f]of e.mergeFromVert.entries())l[f]=e.mergeToVert[h];for(const[h,f]of e.triVerts.entries()){const d=l[f];f!==d&&(b.push(h),u.push(d))}}if(b.length>0){const h=s.createAccessor("merge from").setBuffer(r).setType(C.Type.SCALAR).setArray(new Uint32Array(b)),f=s.createAccessor("merge to").setBuffer(r).setType(C.Type.SCALAR).setArray(new Uint32Array(u));A.setMerge(h,f)}return n}function En(s){if(!s)return;const e=s.listPrimitives();for(const r of e){r.getIndices()?.dispose();for(const i of r.listAttributes())i.dispose()}const t=s.getExtension("EXT_mesh_manifold");t&&(t.getIndices()?.dispose(),t.getMergeIndices()?.dispose(),t.getMergeValues()?.dispose()),s.dispose()}function gs(s,e,t,r){const i=e.getArray(),n=e.getElementSize(),a=e.getCount();for(let c=0;c<a;++c)for(let o=0;o<n;++o)s[t*c+r+o]=i[c*n+o]}function Xr(s,e,t){const r=[];let i=0;for(const n of t){const a=X[n].components;if(X[n].type==null){i+=a;continue}const c=s.getAttribute(n);c&&gs(r,c,e,i),i+=a}return r}export{F as E,te as I,B as L,pn as M,C as Q,ve as S,Jr as T,hn as _,ne as a,rs as b,Ge as c,de as d,Ne as e,ct as f,En as g,M as h,H as i,Qe as j,gn as k,Ce as n,mn as r,dn as s,Ke as t,ss as v,yn as w,Fr as z};
